<!-- 
    Developed by Timba Software Corp. www.timbasoftware.com admin@timbasoftware.com
    This page lists plans
    @author Dario Levy <dlevy@timbasoftware.com>
    -->
    <apex:page id="Calculate" controller="XactlyExpress.XactlySMBCalculateCalculate" sidebar="false" showHeader="false" standardStylesheets="false" action="{!redirectWhenAccessIsDenied}">
    <c:XactlySMBCursor />
    <title>{!$Label.Calculate}: {!$Label.CalculateWizardStep3}</title>
    <!-- PAGE WRAPPER -->
    <div class="pageContent" id="pContent">
            <apex:form id="theForm">
                <!-- HEADER -->
                <apex:outputPanel layout="block" styleClass="header">
                    <c:XactlySMBHeader useGearCalc="true" isAdmin="{!isAdmin}" calcConfgCanSchedule="{!canSchedule}" isActive="{!isActive}" nbrSeparator="{!nbrSeparator}" nbrDecimal="{!nbrDecimal}" currentUserOrSlected="{!currentUserOrSlected}" emulatingUserURLAppend="{!emulatingUserURLAppend}" wqlabel="{!currentSettings.quotasPluralCap}" wclabel="{!currentSettings.creditsPluralCap}" wlabel="{!currentSettings.dealsPluralCap}" wtype="calculate" step="3" hlabel="{!$Label.xactlyexpress__CalculateComissions}" stepHelp="CalculateStep2" showPrevious="true" showNext="true" showSave="false" showRefresh="false" showExport="false" selected="1" selectedLevel2="3" calcBatchSize="{!customBatchSize}"/>
                </apex:outputPanel>
            <div  class="error">
            <!-- INSUFFICIENT PERMISSIONS -->
                <apex:outputPanel rendered="{!!isAdmin || !isActive}">
                    <c:XactlySMBErrorMsg error="{!$Label.xactlyexpress__InsufficientPermissions}" />
                </apex:outputPanel>
            </div>
            
            <div id="shadowContainer" class="shadowContainer">
            <apex:outputpanel layout="block" id="chatter" styleClass="additionalContent" rendered="{!isAdmin && isActive}">
                <c:XactlySMBChatterWall objectId="{!$User.Id}" showHeader="true" showWall="true" currentPage="{!$CurrentPage.Name}" chatterCurrentUserImageUrl="{!chatterCurrentUser_ImageUrl}" rendered="{!isChatterEnabled && isChatterLoaded}"/>
            </apex:outputpanel>
                        
            <!-- MAIN CONTENT -->
              
                 <div class="msgBubble">
                    <div class="msgContent"></div>
                 </div>
            
            <apex:outputPanel layout="block" id="mainContent" styleClass="mainContent" rendered="{!isAdmin && isActive}">
                <!-- CONTENT -->   
                <apex:outputPanel layout="block" id="mainPopup"></apex:outputPanel>
                
                
                    <apex:outputPanel id="errorMsg" layout="block" style="margin-left:30px;">
                        <apex:outputPanel layout="block" rendered="{!IF(errorMsg!='', true, false)}" >
                            <c:XactlySMBErrorMsg error="{!errorMsg}" errStyle="color:#dd0000;" />
                        </apex:outputPanel>
                    </apex:outputPanel>
                
                <apex:inputHidden id="runningProcess" value="{!runningProcess}" />
                <input type="text" style="display:none;" id="runningProcess" value="{!$Component.runningProcess}" />
             
                <!-- NEW UI START -->
                <apex:outputPanel styleclass="tablewrapper" id="tablewrapperID" layout="block">
                    <apex:inputHidden id="showSteps" value="{!showSteps}" />
                    <apex:inputHidden id="showDetailsPlans" value="{!showDetailsPlans}" />
                    <apex:inputHidden id="showLogs" value="{!showLogs}" />
                    <apex:inputHidden id="showUndoOptions" value="{!showUndoOptions}" />
                    <input type="text" style="display:none;" id="showSteps" value="{!$Component.showSteps}" />
                    <input type="text" style="display:none;" id="showDetailsPlans" value="{!$Component.showDetailsPlans}" />
                    <input type="text" style="display:none;" id="showLogs" value="{!$Component.showLogs}" />
                    <input type="text" style="display:none;" id="showUndoOptions" value="{!$Component.showUndoOptions}" />
                    <div class="borderSup" ></div>
                    <!-- NEW UI HEADER START -->
                    <div class="tableItemWrapper even" id="headerWrapper" style="height:30px;"> 
                        <div class="tableCell tableCell_1"><div class="cellPadding fontbold fontheader">{!$Label.Step}</div></div>
                        <div class="tableCell tableCell_2"><div class="cellPadding fontbold fontheader">{!$Label.SelectPlan}</div></div>
                        <div class="tableCell tableCell_3"><div class="cellPadding fontbold fontheader">{!$Label.ProcessLabel}</div></div>
                        <div class="tableCell tableCell_4"><div class="cellPadding fontbold fontheader">{!$Label.Status}</div></div>
                        <div id="detailsW" class="tableCell tableCell_5"><div class="cellPadding fontbold fontheader">{!$Label.DetailCap}</div></div>
                    </div>
                    <!-- NEW UI HEADER END -->
                    <!-- NEW UI GENERAL STEPS START -->
                    <div class="tableItemWrapper" id="generalStepsWrapper" style="height:60px;background:#eeeeee;">
                        <div class="tableCell tableCell_1">
                            <table cellspacing="0" cellpadding="0" border="0" class="btn_wrapper"><tr><td>
                                <apex:outputPanel layout="block" styleClass="btn_silver_wrapper" onmouseover="btnSilverOver(this);" onmouseout="btnSilverOut(this);" onclick="toggleSteps();">
                                    <apex:outputPanel layout="inline" styleClass="btn_silver">
                                        <apex:outputPanel layout="inline" styleClass="btn_silver_r">
                                            <span id="btn_lbl_hide_steps" style="display:none" class="a_btn_silver a_btn_silver_blue">{!$Label.hideSteps}</span>
                                            <span id="btn_lbl_show_steps" class="a_btn_silver a_btn_silver_blue">{!$Label.showSteps}</span>
                                        </apex:outputPanel>
                                    </apex:outputPanel>
                                </apex:outputPanel>
                            </td></tr></table>
                        </div>
                        <div class="tableCell tableCell_2"><div class="cellPadding" style="margin-top:23px !important;">{!$Label.runAllPlansAllSteps}</div></div>
                        <div class="tableCell tableCell_3">
                            <table cellspacing="0" cellpadding="0" border="0" class="btn_wrapper"><tr><td>
                                <apex:outputPanel layout="block" styleClass="btn_c_wrapper btn_action {!IF(runningProcess || plan.size == 0 || isReadOnlyAdmin, 'disabledOpacityButton', '')}" onmouseover="{!IF(runningProcess || plan.size == 0 || isReadOnlyAdmin, 'return false;', '')}jQuery(jQuery(this).find('.btn_c')[0]).addClass('btn_green_bg_up');jQuery(jQuery(this).find('.btn_c')[0]).removeClass('btn_green_bg');jQuery(jQuery(this).find('.btn_c_r')[0]).addClass('btn_green_r_bg_up');jQuery(jQuery(this).find('.btn_c_r')[0]).removeClass('btn_green_r_bg');" onmouseout="{!IF(runningProcess || plan.size == 0 || isReadOnlyAdmin, 'return false;', '')}jQuery(jQuery(this).find('.btn_c')[0]).removeClass('btn_green_bg_up');jQuery(jQuery(this).find('.btn_c')[0]).addClass('btn_green_bg');jQuery(jQuery(this).find('.btn_c_r')[0]).removeClass('btn_green_r_bg_up');jQuery(jQuery(this).find('.btn_c_r')[0]).addClass('btn_green_r_bg');" onclick="{!IF(runningProcess || plan.size == 0 || isReadOnlyAdmin, 'return false;', '')}actionNV(this, 'runAllSteps');">
                                    <apex:outputPanel layout="inline" styleClass="btn_c btn_green_bg">
                                        <apex:outputPanel layout="inline" styleClass="btn_c_r btn_green_r_bg">
                                            <span class="font_btn_green"><div class="text_wp_btn1">{!$Label.xactlyexpress__RunAllSteps}</div></span>
                                        </apex:outputPanel>
                                    </apex:outputPanel>
                                </apex:outputPanel>
                            </td></tr></table>
                        </div>
                        <div class="tableCell tableCell_4">
                            <div class="statusWrapper1">
                                <apex:outputpanel layout="none" rendered="{!multipleStepsType == MULTIPLE_STEPS_ALL_STEPS}">
                                    <div class="swirly" style="display:{!IF((multipleStepsStatus=='Queued' || multipleStepsStatus=='Running'),'block;','none;')}"><img src="{!URLFOR($Resource.XactlySMBResources, 'img/icons/loader2.gif')}" width="32" height="32" /></div>
                                   <div class="statusIMG {!IF(multipleStepsStatus=='Failed','statusWarning',IF(multipleStepsStatus=='Finished','statusfinish',IF(multipleStepsStatus==$Label.NeedToRerun,'statusNotAllStepsProcessed','statusfinish')))}" style="display:{!IF((multipleStepsStatus=='Queued' || multipleStepsStatus=='Running'),'none;','block;')}"></div>
                                    <div style="clear:both;"></div>
                                    <div class="statusDescription" style="display:{!IF((multipleStepsStatus=='Queued' || multipleStepsStatus=='Running'),'none;','block;')}">{!multipleStepsStatus}</div>
                                </apex:outputpanel>
                            </div>
                        </div>
                        <div class="tableCell tableCell_5">
                            <div class="cellPadding">
                                <apex:outputpanel layout="none" rendered="{!multipleStepsType == MULTIPLE_STEPS_ALL_STEPS}">
                                   <div style="{!IF(multipleStepsPhase == 'Gen Comm Stmt', 'margin-top:0px;text-align:center;', 'margin-top:23px;text-align:center;')}">                                  
                                    <c:XactlySMBLongTextBubble wrappStyle="" text="{!multipleStepsMsg}" maxLength="{!IF(multipleStepsStatus=='Failed',45,70)}" />
                                   </div>
                                </apex:outputpanel>
                            </div>
                        </div>               
                    </div>
                    <!-- NEW UI GENERAL STEPS END -->
                    <!-- NEW UI CREDIT-PAYMENT START -->
                    <div class="tableItemWrapper" id="Steps1Wrapper" style="{!IF(showSteps, '', 'display:none')}">
                        <table cellspacing="0" cellpadding="0" border="0">
                        <tr>
                        <td style="width:131px;vertical-align:top">
                            <div class="cellPadding fontbold" style="margin-top:17px;">
                                {!$Label.Step} 1
                            </div>
                        </td>
                        <td>
                        <div style="float:left;width:885px;">
                            <div class="tableItem2Wrapper">
                                <div class="tableCell tableCell_2">
                                    <div class="cellPadding">
                                        <div id="planListArrow" class="inteactionIconSprite stepArrowRight" onclick="togglePlanList(false);">&nbsp;</div>
                                        {!ProcessCreditsAndPaymentsLabel}
                                        <div style="cursor:pointer;" class="imgInformation inteactionIconSprite info" onmouseover="showInformation(this, 0);" onmouseout="hideInformation()">&nbsp;</div>
                                    </div>
                                </div>
                                <div class="tableCell tableCell_3">
                                    <table cellspacing="0" cellpadding="0" border="0" class="btn_wrapper"><tr><td>
                                        <apex:outputPanel layout="block" styleClass="btn_silver_wrapper btn_action {!IF(runningProcess || plan.size == 0 || isReadOnlyAdmin, 'disabledOpacityButton', '')}" onmouseover="{!IF(runningProcess || plan.size == 0 || isReadOnlyAdmin, 'return false;', '')} btnSilverOver(this);" onmouseout="{!IF(runningProcess || plan.size == 0 || isReadOnlyAdmin, 'return false;', '')}btnSilverOut(this);" onclick="{!IF(runningProcess || plan.size == 0 || isReadOnlyAdmin, 'return false;', '')}actionNV(this, 'runCreditAndPayment');">
                                            <apex:outputPanel layout="inline" styleClass="btn_silver">
                                                <apex:outputPanel layout="inline" styleClass="btn_silver_r">
                                                    <span class="a_btn_silver a_btn_silver_blue"><div class="text_wp_btn2">{!ProcessCreditsAndPaymentsLabel}</div></span>
                                                </apex:outputPanel>
                                            </apex:outputPanel>
                                        </apex:outputPanel>
                                    </td></tr></table>
                                </div>
                                <div class="tableCell tableCell_4">
                                    <div class="statusWrapper1">
                                        <apex:outputpanel layout="none" rendered="{!multipleStepsType == MULTIPLE_STEPS_CREDIT_PAYMENT}">
                                            <div class="swirly" style="display:{!IF((multipleStepsStatus=='Queued' || multipleStepsStatus=='Running') && isRunningCurrentPeriod,'block;','none;')}"><img src="{!URLFOR($Resource.XactlySMBResources, 'img/icons/loader2.gif')}" width="32" height="32"/></div>
                                            <div class="statusIMG {!IF(creditStatus==$Label.NotAllStepsRun,'statusNotAllStepsProcessed',IF(creditStatus==$Label.NotAllPlansRun,'statusNotAllStepsProcessed',IF(multipleStepsStatus='Failed','statusWarning',IF(multipleStepsStatus='Finished','statusfinish','statusfinish'))))}" style="margin-right:40px;display:{!IF(multipleStepsStatus=='Queued' || multipleStepsStatus=='Running','none;','block;')}"></div>
                                            <div style="clear:both;"></div>
                                            <div class="statusDescription" style="display:{!IF(multipleStepsStatus=='Queued' || multipleStepsStatus=='Running','none;','block;')}">{!multipleStepsStatus}</div>
                                        </apex:outputpanel>
                                        <apex:outputpanel layout="none" rendered="{!multipleStepsType != MULTIPLE_STEPS_CREDIT_PAYMENT}">
                                            <div class="swirly" style="display:{!IF(((creditStatus=='Queued' || creditStatus=='Running')||(planStatus == 'Queued'||planStatus == 'Running')) && isRunningCurrentPeriod,'block;','none;')}"><img src="{!URLFOR($Resource.XactlySMBResources, 'img/icons/loader2.gif')}" width="32" height="32"/></div>
                                            <div class="statusIMG {!IF(planStatus==$Label.NotAllPlansRun ||creditStatus==$Label.NotAllPlansRun || creditStatus==$Label.NotAllStepsProcessed || creditStatus==$Label.NotAllStepsRun || creditStatus==$Label.needToRerun || creditStatus==$Label.needToRerun,'statusNotAllStepsProcessed',IF(toCreditResult.fail,'statusWarning',IF(creditStatus='Finished','statusfinish',IF(creditStatus=$Label.NotCalculated ||creditStatus='','statusNotCalc',IF(creditStatus=$Label.NeedToRerun,'statusNotAllStepsProcessed','statusfinish')))))}" style="display:{!IF((creditStatus=='Queued' || creditStatus=='Running')||(planStatus == 'Queued'||planStatus == 'Running'),'none;','block;')}"></div>
                                            <div style="clear:both;"></div>
                                            <div class="statusDescription" style="width:120px;margin-top:2px;display:{!IF((creditStatus=='Queued' || creditStatus=='Running')||(planStatus == 'Queued'||planStatus == 'Running'),'none;','block;')}">{!IF(toCreditResult.fail,$Label.failed,IF(creditStatus=planStatus, planStatus,IF(creditStatus=$Label.needToRerun,$Label.needToRerun, IF(planStatus='Failed'||planStatus=$Label.needToRerun||planStatus=$Label.NeverRun||planStatus=$Label.NotCalculated||planStatus=$Label.NotAllPlansRun, $Label.NotAllStepsProcessed, creditStatus))))}</div>
                                        </apex:outputpanel>
                                    </div>
                                </div>
                                <div class="tableCell tableCell_5" style="overflow: hidden;">
                                    <div class="cellPadding">
                                        <apex:outputpanel layout="none" rendered="{!multipleStepsType == MULTIPLE_STEPS_CREDIT_PAYMENT}">
                                            <c:XactlySMBLongTextBubble wrappStyle="" text="{!multipleStepsMsg}" maxLength="60" />
                                        </apex:outputpanel>
                                    </div>
                                </div>
                            </div>
                            <div class="tableItem2Wrapper" id="secondaryPlanList1" style="height:82px;{!IF(showDetailsPlans,'','display:none')}">
                                <div class="tableCell tableCell_2">
                                    <div class="cellPadding2">
                                        <apex:inputcheckbox disabled="{!runningProcess || plan.size == 0}" styleClass="individualCheckbox selectAllPlanBox" onclick="selectPlanList(this);" value="{!selectedAllPlans}" style="margin-top: 6px;"/>                                    
                                        {!$Label.SelectAllPlans}
                                    </div>
                                </div>
                                <div class="tableCell tableCell_3_a">
                                    <table cellspacing="0" cellpadding="0" border="0" class="btn_wrapper"><tr><td>
                                        <apex:outputPanel layout="block" styleClass="btn_silver_wrapper btn_action {!IF(runningProcess || plan.size == 0 || isReadOnlyAdmin || !activeBtnCredit, 'disabledOpacityButton', '')}" onmouseover=" {!IF(runningProcess || plan.size == 0 || isReadOnlyAdmin||  !activeBtnCredit, 'return false;', '')}btnSilverOver(this);" onmouseout="{!IF(runningProcess || plan.size == 0 || isReadOnlyAdmin || !activeBtnCredit, 'return false;', '')}btnSilverOut(this);" onclick="{!IF(runningProcess || plan.size == 0 || isReadOnlyAdmin || !activeBtnCredit, 'return false;', '')}actionNV(this, 'runCredit');">
                                            <apex:outputPanel layout="inline" styleClass="btn_silver">
                                                <apex:outputPanel layout="inline" styleClass="btn_silver_r">
                                                    <span class="a_btn_silver a_btn_silver_blue">{!runCreditLabel}</span>
                                                </apex:outputPanel>
                                            </apex:outputPanel>
                                        </apex:outputPanel>
                                    </td></tr></table>
                                </div>
                                <div class="tableCell tableCell_3_b">
                                    <table cellspacing="0" cellpadding="0" border="0" class="btn_wrapper"><tr><td>
                                        <apex:outputPanel layout="block" styleClass="btn_silver_wrapper btn_action {!IF(runningProcess || plan.size == 0 || isReadOnlyAdmin || !activeBtnPayment, 'disabledOpacityButton', '')}" onmouseover="{!IF(runningProcess || plan.size == 0 || isReadOnlyAdmin || !activeBtnPayment, 'return false;', '')}btnSilverOver(this);" onmouseout="{!IF(runningProcess || plan.size == 0 || isReadOnlyAdmin || !activeBtnPayment, 'return false;', '')}btnSilverOut(this);" onclick="{!IF(runningProcess || plan.size == 0 || !activeBtnPayment || isReadOnlyAdmin, 'return false;', '')}actionNV(this, 'runPayment');">
                                            <apex:outputPanel layout="inline" styleClass="btn_silver">
                                                <apex:outputPanel layout="inline" styleClass="btn_silver_r">
                                                    <span class="a_btn_silver a_btn_silver_blue">{!$Label.xactlyexpress__RunPayments}</span>
                                                </apex:outputPanel>
                                            </apex:outputPanel>
                                        </apex:outputPanel>
                                    </td></tr></table>
                                </div>
                                <div class="tableCell tableCell_4">
                                    <div class="statusWrapper1">
                                    </div>
                                 </div>
                                <div class="tableCell tableCell_5">

                                    <div class="cellPadding">
                                             <div id="step1Details" class="details">
                                                      <div class="processInformation">
                                                        <apex:outputPanel layout="none" rendered="{!IF((creditStatus=='Queued' || creditStatus=='Running') || (planStatus=='Queued' || planStatus=='Running'),false,true)}">      
                                                            <apex:outputPanel layout="none" rendered="{!IF(planList.size>0,false,true)}"> 
                                                                {!$Label.xactlyexpress__NoPlanstoCalculate}
                                                            </apex:outputPanel> 
                                                            <apex:outputPanel layout="none" rendered="{!IF(planList.size>0 && !toCreditResult.fail && !toCalcResult.fail,true,false)}">                                         
                                                                    <apex:outputtext value="{!$Label.xactlyexpress__DealsProcessed}" >
                                                                        <apex:Param value="{!currentSettings.dealsPluralCap}"/>
                                                                    </apex:outputtext> :&nbsp;&nbsp;<apex:outputtext value="{!toCreditResult.dealsProcessed}" /><br />
                                                                    <apex:outputtext value="{!currentSettings.creditsPluralCap}: {!$Label.xactlyexpress__PayeesProcessed}" /> :&nbsp;&nbsp;<apex:outputtext value="{!toCreditResult.payeesProcessed}" /><br />                                                        

                                                                    <apex:outputtext value="{!$Label.xactlyexpress__CreditsProcessed}" >
                                                                        <apex:Param value="{!currentSettings.creditsPluralCap}"/>
                                                                    </apex:outputtext> :&nbsp;&nbsp;<apex:outputtext value="{!toCalcResult.dealsProcessed}" /><br />
                                                                    <apex:outputtext value="Payment: {!$Label.xactlyexpress__PayeesProcessed}" /> :&nbsp;&nbsp;<apex:outputtext value="{!toCalcResult.payeesProcessed}" /><br />
                                                            </apex:outputPanel>                                   
                                                            <apex:outputpanel layout="block" rendered="{!IF((multipleStepsType != MULTIPLE_STEPS_ALL_STEPS) && (toCreditResult.fail ||  toCalcResult.fail),true,false)}" styleClass="errorStatus">
                                                                <div class="processStatus ">
                                                                    <apex:outputtext value="{!IF(toCreditResult.fail,$Label.xactlyexpress__Crediting,$Label.xactlyexpress__Calculation)}:" />
                                                                </div>
                                                                <c:XactlySMBLongTextBubble wrappStyle="" text="{!IF(toCreditResult.fail, toCreditResult.process.XactlyExpress__ErrorMsg__c, toCalcResult.process.XactlyExpress__ErrorMsg__c)}" maxLength="20" />
                                                            </apex:outputpanel>
                                                           
                                                        </apex:outputPanel>
                                                        <apex:outputPanel layout="none" rendered="{!IF((creditStatus=='Queued' || creditStatus=='Running') || (planStatus=='Queued' || planStatus=='Running'),true,false)}">      
                                                               {!$Label.xactlyexpress__Processing}...
                                                        </apex:outputPanel>
                                                      </div>
                                             </div>
                                    </div>


                                </div>
                            </div>
                        </div>
                        </td>
                        </tr>  
                        </table>
                        
                        <table cellspacing="0" cellpadding="0" border="0" id="secondaryPlanList2" style="{!IF(!showDetailsPlans || plan.size == 0,'display:none','')}">
                        <tr>
                        <td style="width:131px;">
                            &nbsp;
                        </td>
                        <td>
                        <div style="float:left;width:885px;">
                            <apex:variable var="countPlans" value="{!1}" />
                            <apex:repeat value="{!planList}" var="iter">
                            
                             <div class="tableItem2Wrapper" style="{!IF(countPlans = planList.size, 'border-bottom:none;', '')}">
                                <div class="tableCell tableCell_2">
                                    <div class="cellPadding2">
                                    <apex:inputcheckbox disabled="{!runningProcess}" styleClass="individualCheckbox planCheckBox" onclick="cleanSelectAllPlans();" value="{!iter.toCalculate}" style=" margin-right: 15px;margin-top: 6px;"/>
                                    <c:XactlySMBLongTextBubble wrappStyle="" text="{!iter.plan.name}" maxLength="31" />
                                    </div>
                                </div> 
                                <div class="tableCell tableCell_3_a">
                                    <div class="statusWrapper1">
                                        <div class="statusIMGDot {!IF(iter.statusCredit='Failed','statusIMGDotFailed',IF(iter.statusCredit='Finished','statusIMGDotFinish',IF(iter.statusCredit=$Label.NotCalculated,' ',IF(iter.statusCredit=$Label.NeedToRerun,'statusIMGDotFinish disabledOpacityButton','statusIMGDotFinish'))))}" style="display:{!IF(iter.status=='Queued' || iter.status=='Running','none;','block;')}" ></div>
                                    </div>
                                </div>
                                <div class="tableCell tableCell_3_b">
                                    <div class="statusWrapper1">
                                        <div class="statusIMGDot {!IF(iter.statusPayment='Failed','statusIMGDotFailed',IF(iter.statusPayment='Finished','statusIMGDotFinish',IF(iter.statusPayment=$Label.NotCalculated,' ',IF(iter.statusPayment=$Label.NeedToRerun,'statusIMGDotFinish disabledOpacityButton','statusIMGDotFinish'))))}" style="display:{!IF(iter.status=='Queued' || iter.status=='Running','none;','block;')}" ></div>
                                    </div>
                                </div>
                                <div class="tableCell tableCell_4">
                                    <div class="statusWrapper1">
                                        <div class="swirly" style="margin-left:42px;display:{!IF(iter.status=='Queued' || iter.status=='Running','block;','none;')}"><img style="margin-left: 6px;" src="{!URLFOR($Resource.XactlySMBResources, 'img/icons/loader2.gif')}" width="32" height="32"/></div>
                                        <div class="statusDescription" style="display:{!IF(iter.status=='Queued' || iter.status=='Running','none;','block;')}">{!iter.statusMsg}</div>
                                    </div>
                                </div>
                                <div class="tableCell tableCell_5">
                                    <div class="cellPadding">
                                        <div class="details">
                                        {!creditLabel}: {!iter.statusCredit} <br />
                                        {!$Label.payment}: {!iter.statusPayment}
                                        </div>
                                    </div>
                                </div>
                             </div>
                            <apex:variable var="countPlans" value="{!countPlans + 1}" />
                            </apex:repeat>
                        </div>
                        </td>
                        </tr>  
                        </table>                        
                    </div>
                    <!-- NEW UI CREDIT-PAYMENT END -->
                    <!-- NEW UI RELEASE START -->
                    <div class="tableItemWrapper even" id="ReleaseStepWrapper" style="height:45px;{!IF(showSteps, '', 'display:none')}">
                        <div class="tableCell tableCell_1"><div class="cellPadding fontbold" style="margin-top:17px;">{!$Label.Step} 2</div></div>
                        <div class="tableCell tableCell_2">
                            <div class="cellPadding" style="margin-top:17px;">
                                {!$Label.ReleasesAllPrevRun}
                                <div style="cursor:pointer;" class="imgInformation inteactionIconSprite info" onmouseover="showInformation(this, 1);" onmouseout="hideInformation()">&nbsp;</div>
                            </div>
                        </div>
                        <div class="tableCell tableCell_3">
                            <table cellspacing="0" cellpadding="0" border="0" class="btn_wrapper"><tr><td>
                                        <apex:outputPanel layout="block" styleClass="btn_silver_wrapper btn_action {!IF(runningProcess || plan.size == 0 || !activeBtnRelease || isReadOnlyAdmin, 'disabledOpacityButton', '')}" onmouseover="{!IF(runningProcess || plan.size == 0 || !activeBtnRelease || isReadOnlyAdmin, 'return false;', '')}btnSilverOver(this);" onmouseout="{!IF(runningProcess || plan.size == 0 || !activeBtnRelease || isReadOnlyAdmin, 'return false;', '')}btnSilverOut(this);" onclick="{!IF(runningProcess || plan.size == 0 || !activeBtnRelease || isReadOnlyAdmin, 'return false;', '')}actionNV(this, 'runRelease');">
                                            <apex:outputPanel layout="inline" styleClass="btn_silver">
                                                <apex:outputPanel layout="inline" styleClass="btn_silver_r">
                                                    <span class="a_btn_silver a_btn_silver_blue"><div class="text_wp_btn2">{!$Label.xactlyexpress__reprocessCurrentReleases}</div></span>
                                                </apex:outputPanel>
                                            </apex:outputPanel>
                                        </apex:outputPanel>
                            </td></tr></table>
                        </div>
                        <div class="tableCell tableCell_4">
                            <div class="statusWrapper1"> 
                                        <div class="swirly" style="display:{!IF(releaseStatus=='Queued' || releaseStatus=='Running','block;','none;')}"><img src="{!URLFOR($Resource.XactlySMBResources, 'img/icons/loader2.gif')}" width="32" height="32"/></div>
                                        <div class="statusIMG {!IF(releaseStatus='Failed','statusWarning',IF(!ISNULL(toReleaseLog) && toReleaseLog.releasesFailed > 0 && releaseStatus != $Label.needToReRun ,'statusFinishedWithErrors',IF(releaseStatus='Finished','statusfinish',IF(releaseStatus=$Label.NotCalculated||releaseStatus=''||releaseStatus=$Label.NoPlanstoCalculate||ISNULL(toReleaseLog),'statusNotCalc',IF(releaseStatus=$Label.NeedToRerun,'statusNotAllStepsProcessed','statusfinish')))))}" style="float:none;display:{!IF(releaseStatus=='Queued' || releaseStatus=='Running','none;','block;')}"></div>
                                        <div class="statusDescription" style="display:{!IF(releaseStatus=='Queued' || releaseStatus=='Running','none;','block;')}">{!releaseStatus}</div>
                            </div>
                        </div>
                        <div class="tableCell tableCell_5">
                            <div class="cellPadding"> 
                                <div class="details" style="{!IF(!ISNULL(toReleaseLog) && !toReleaseLog.fail && (releaseStatus != $Label.NeedToRerun && releaseStatus != $Label.NotCalculated) && !(releaseStatus=='Queued' || releaseStatus=='Running'),'','padding-top:9px;')}">
                                    
                                             <div class="details">
                                                      <div class="processInformation">
                                                      
                                                        
                                                        <apex:outputPanel layout="none" rendered="{!IF(releaseStatus=='Queued' || releaseStatus=='Running',false,true)}">      
                                                            <apex:outputPanel layout="none" rendered="{!ISNULL(toReleaseLog)}"> 
                                                               {!$Label.xactlyexpress__noReleasesToProcess}
                                                             </apex:outputPanel> 
                                                            <apex:outputPanel layout="none" rendered="{!!ISNULL(toReleaseLog) && !toReleaseLog.fail && (releaseStatus != $Label.xactlyexpress__NeedToRerun && releaseStatus != $Label.xactlyexpress__NotCalculated)}">
                                                                     <apex:outputtext value="{!$Label.xactlyexpress__Success}" />
                                                                     :&nbsp;&nbsp;<apex:outputtext value="{!toReleaseLog.releasesSuccess}" /><br />
                                                                     <apex:outputtext value="{!$Label.xactlyexpress__Errors}" />
                                                                     :&nbsp;&nbsp;<apex:outputtext value="{!toReleaseLog.releasesFailed}" /><br />                                                                    
                                                            </apex:outputPanel>
                                                            <apex:outputPanel layout="none" rendered="{!releaseStatus == $Label.xactlyexpress__NeedToRerun}"> 
                                                               {!$Label.xactlyexpress__Release}: {!releaseStatus}
                                                             </apex:outputPanel> 
                                                            <apex:outputpanel layout="block" rendered="{!toReleaseLog.fail}" styleClass="errorStatus">
                                                                <div class="processStatus {!IF(toReleaseLog.fail, 'calculationFail', '')}">
                                                                    <apex:outputtext rendered="" style="display:none;" value="{!$Label.xactlyexpress__Release}" />
                                                                </div>
                                                                <c:XactlySMBLongTextBubble wrappStyle="" text="{!toReleaseLog.process.XactlyExpress__ErrorMsg__c}" maxLength="20" />
                                                            </apex:outputpanel>
                                                        </apex:outputPanel>
                                                        <apex:outputPanel layout="none" rendered="{!IF(releaseStatus=='Queued' || releaseStatus=='Running',true,false)}">      
                                                               {!$Label.xactlyexpress__Processing}...
                                                        </apex:outputPanel>
                                                      </div>
                                             </div>
                                    
                                    
                                </div>
                            </div>
                        </div>
                                
                    </div>
                    <!-- NEW UI RELEASE END -->
                    <!-- NEW UI FINALIZE START -->
                    <div class="tableItemWrapper" id="FinalizeWrapper" style="height:45px;{!IF(showSteps, '', 'display:none')}">
                        <div class="tableCell tableCell_1"><div class="cellPadding fontbold" style="margin-top:17px;">{!$Label.Step} 3</div></div>
                        <div class="tableCell tableCell_2">
                            <div class="cellPadding" style="margin-top:17px;">
                                {!$Label.xactlyexpress__FinalizePaymentFinished}
                                <div style="cursor:pointer;" class="imgInformation inteactionIconSprite info" onmouseover="showInformation(this, 2);" onmouseout="hideInformation()">&nbsp;</div>
                            </div>
                        </div>
                        <div class="tableCell tableCell_3">
                            <table cellspacing="0" cellpadding="0" border="0" class="btn_wrapper"><tr><td>
                                        <apex:outputPanel layout="block" styleClass="btn_silver_wrapper btn_action {!IF(runningProcess || plan.size == 0 || !activeBtnFinalize || isReadOnlyAdmin, 'disabledOpacityButton', '')}" onmouseover="{!IF(runningProcess || plan.size == 0 || !activeBtnFinalize || isReadOnlyAdmin, 'return false;', '')}btnSilverOver(this);" onmouseout="{!IF(runningProcess || plan.size == 0 || !activeBtnFinalize || isReadOnlyAdmin, 'return false;', '')}btnSilverOut(this);" onclick="{!IF(runningProcess || plan.size == 0 || !activeBtnFinalize || isReadOnlyAdmin, 'return false;', '')}actionNV(this, 'runFinalize');">
                                            <apex:outputPanel layout="inline" styleClass="btn_silver">
                                                <apex:outputPanel layout="inline" styleClass="btn_silver_r">
                                                    <span class="a_btn_silver a_btn_silver_blue"><div class="text_wp_btn2">{!$Label.xactlyexpress__FinalizePaymentFinished}</div></span>
                                                </apex:outputPanel>
                                            </apex:outputPanel>
                                        </apex:outputPanel>
                            </td></tr></table>
                        </div>
                        <div class="tableCell tableCell_4">
                            <div class="statusWrapper1">
                                <apex:outputpanel layout="none" rendered="{!(allowedCommStmt && showCommStmt) || !isRunningCurrentPeriod}">
                                        <div class="swirly" style="display:{!IF(isRunningCurrentPeriod && (commStmtStatus=='Queued' || commStmtStatus=='Running' || (((multipleStepsType == MULTIPLE_STEPS_COMM_STMT && multipleStepsPhase == 'Gen Comm Stmt') || (multipleStepsType == MULTIPLE_STEPS_ALL_STEPS && multipleStepsPhase == 'Gen Comm Stmt')) && (multipleStepsStatus=='Queued'||multipleStepsStatus=='Running'))),'block;','none;')}"><img src="{!URLFOR($Resource.XactlySMBResources, 'img/icons/loader2.gif')}" width="32" height="32"/></div>
                                        <div class="statusIMG {!IF(commStmtStatus='Failed','statusWarning',IF(commStmtStatus='Finished','statusfinish',IF(commStmtStatus=$Label.NotCalculated,' ',IF(commStmtStatus=$Label.NeedToRerun,'statusNotAllStepsProcessed','statusfinish'))))}" style="float:none;display:{!IF(isRunningCurrentPeriod && (commStmtStatus=='Queued' || commStmtStatus=='Running' || (((multipleStepsType == MULTIPLE_STEPS_COMM_STMT && multipleStepsPhase == 'Gen Comm Stmt') || (multipleStepsType == MULTIPLE_STEPS_ALL_STEPS && multipleStepsPhase == 'Gen Comm Stmt')) && (multipleStepsStatus=='Queued'||multipleStepsStatus=='Running'))),'none;','block;')}"></div>
                                        <div class="statusDescription" style="display:{!IF(isRunningCurrentPeriod && (commStmtStatus=='Queued' || commStmtStatus=='Running' || (((multipleStepsType == MULTIPLE_STEPS_COMM_STMT && multipleStepsPhase == 'Gen Comm Stmt') || (multipleStepsType == MULTIPLE_STEPS_ALL_STEPS && multipleStepsPhase == 'Gen Comm Stmt')) && (multipleStepsStatus=='Queued'||multipleStepsStatus=='Running'))),'none;','block;')}">{!commStmtStatus}</div>
                                </apex:outputpanel>
                                <apex:outputpanel layout="none" rendered="{!(!allowedCommStmt || !showCommStmt)}">
                                        <div class="swirly" style="display:{!IF(isRunningCurrentPeriod && (finalizeStatus=='Queued' || finalizeStatus=='Running' || (((multipleStepsType == MULTIPLE_STEPS_COMM_STMT && (multipleStepsPhase == 'Finalize Payment' || multipleStepsPhase == 'Payout Detail')) || (multipleStepsType == MULTIPLE_STEPS_ALL_STEPS && (multipleStepsPhase != 'Gen Comm Stmt' && multipleStepsPhase!='Release' && multipleStepsPhase!='Credit' && multipleStepsPhase!='Post' && multipleStepsPhase!='Close period'))) && (multipleStepsStatus=='Queued'||multipleStepsStatus=='Running'))),'block;','none;')}"><img src="{!URLFOR($Resource.XactlySMBResources, 'img/icons/loader2.gif')}" width="32" height="32"/></div>
                                        <div class="statusIMG {!IF(finalizeStatus='Failed','statusWarning',IF(finalizeStatus='Finished','statusfinish',IF(finalizeStatus=$Label.NotCalculated,' ',IF(finalizeStatus=$Label.NeedToRerun,'statusNotAllStepsProcessed',IF(finalizeStatus=$Label.NeverRun,'statusNotCalc','statusfinish')))))}" style="float:none;display:{!IF(finalizeStatus=='Queued' || finalizeStatus=='Running' || (((multipleStepsType == MULTIPLE_STEPS_COMM_STMT && (multipleStepsPhase == 'Finalize Payment' || multipleStepsPhase == 'Payout Detail')) || (multipleStepsType == MULTIPLE_STEPS_ALL_STEPS && (multipleStepsPhase == 'Finalize Payment' || multipleStepsPhase == 'Payout Detail'))) && (multipleStepsStatus=='Queued'||multipleStepsStatus=='Running')),'none;','block;')}"></div>
                                        <div class="statusDescription" style="display:{!IF(finalizeStatus=='Queued' || finalizeStatus=='Running' || (((multipleStepsType == MULTIPLE_STEPS_COMM_STMT && (multipleStepsPhase == 'Finalize Payment' || multipleStepsPhase == 'Payout Detail')) || (multipleStepsType == MULTIPLE_STEPS_ALL_STEPS && (multipleStepsPhase != 'Gen Comm Stmt' && multipleStepsPhase!='Release' && multipleStepsPhase!='Credit' && multipleStepsPhase!='Post' && multipleStepsPhase!= 'Close period'))) && (multipleStepsStatus=='Queued'||multipleStepsStatus=='Running')),'none;','block;')}">{!finalizeStatus}</div>
                                </apex:outputpanel>
                            </div>
                        </div>
                        <div class="tableCell tableCell_5">
                            <div class="cellPadding">
                                             <div class="details">
                                                      <div class="processInformation">
                                                        <apex:outputPanel layout="none" rendered="{!IF(finalizeStatus=='Queued' || finalizeStatus=='Running' || commStmtStatus=='Queued' || commStmtStatus=='Running' || (multipleStepsType == MULTIPLE_STEPS_COMM_STMT && (multipleStepsStatus=='Queued'||multipleStepsStatus=='Running')),false,true)}">
                                                            <apex:outputpanel layout="none" rendered="{!allowedCommStmt && showCommStmt && (!((multipleStepsType == MULTIPLE_STEPS_COMM_STMT || (multipleStepsType == MULTIPLE_STEPS_ALL_STEPS && multipleStepsPhase == 'Gen Comm Stmt')) && (multipleStepsStatus=='Queued'||multipleStepsStatus=='Running')))}">
                                                                <apex:outputPanel layout="none" rendered="{!!ISNULL(toCommStmtLog) && !toCommStmtLog.fail}">
                                                                    <apex:outputtext value="{!commnStmtLabel}: {!commStmtStatus}" /><br />
                                                                </apex:outputPanel>
                                                                <apex:outputpanel layout="block" rendered="{!toCommStmtLog.fail}" styleClass="errorStatus">
                                                                    <c:XactlySMBLongTextBubble wrappStyle="" text="{!commnStmtLabel} {!$Label.xactlyexpress__Failed}: {!toCommStmtLog.process.XactlyExpress__ErrorMsg__c}" maxLength="20" />
                                                                </apex:outputpanel>
                                                            </apex:outputpanel>
                                                            <apex:outputpanel layout="none" rendered="{!!allowedCommStmt || !showCommStmt}">
                                                                <apex:outputPanel layout="none" rendered="{!ISNULL(toFinalizeLog) || (toUndoResult.process.XactlyExpress__Start__c > toFinalizeLog.process.XactlyExpress__Start__c)}"> 
                                                                    {!$Label.xactlyexpress__NoPaymentsToCalculate}
                                                                </apex:outputPanel> 
                                                                <apex:outputPanel layout="none" rendered="{!!ISNULL(toFinalizeLog) && !toFinalizeLog.fail && !(toUndoResult.process.XactlyExpress__Start__c > toFinalizeLog.process.XactlyExpress__Start__c)}">
                                                                    <apex:outputtext value="{!$Label.xactlyexpress__PayeesProcessed}" /> :&nbsp;&nbsp;<apex:outputtext value="{!toFinalizeLog.payeesProcessed}" /><br />
                                                                </apex:outputPanel>
                                                                <apex:outputpanel layout="block" rendered="{!toFinalizeLog.fail}" styleClass="errorStatus">
                                                                    <div class="processStatus {!IF(toFinalizeLog.fail, 'calculationFail', '')}">
                                                                        <apex:outputtext style="display:none;" value="{!$Label.xactlyexpress__FinalizePaymentFinished}" />
                                                                    </div>
                                                                    <c:XactlySMBLongTextBubble wrappStyle="" text="{!toFinalizeLog.process.XactlyExpress__ErrorMsg__c}" maxLength="20" />
                                                                </apex:outputpanel>
                                                            </apex:outputpanel>
                                                        </apex:outputPanel>
                                                        <apex:outputPanel layout="none" rendered="{!IF(finalizeStatus=='Queued' || finalizeStatus=='Running' || commStmtStatus=='Queued' || commStmtStatus=='Running' || ((multipleStepsType == MULTIPLE_STEPS_COMM_STMT || (multipleStepsType == MULTIPLE_STEPS_ALL_STEPS && multipleStepsPhase == 'Gen Comm Stmt')) && (multipleStepsStatus=='Queued'||multipleStepsStatus=='Running')),true,false)}">      
                                                               {!$Label.xactlyexpress__Processing}...
                                                        </apex:outputPanel>
                                                      </div>
                                             </div>
                                    
                            </div>
                        </div>
                    </div>
                    <!-- NEW UI FINALIZE END -->
                    <!-- NEW UI EXTRA BUTTONS START -->
                    <div class="tableItemWrapper" id="extraButtonsWrapper" style="height:65px;{!IF(showSteps, '', 'display:none')}">
                        
                        <div style="width:300px;float:left;">
                                        <apex:outputPanel title="{!$Label.xactlyexpress__tooltip_abortCalculation}" layout="block" styleClass="{!IF(activeBtnAbort && !isReadOnlyAdmin,'btn_silver_wrapper','disabledOpacityButton')}" style="{!IF(!activeBtnAbort,'margin-top: 6px;margin-left:3px','')}" onmouseover="{!IF(!activeBtnAbort || isReadOnlyAdmin,'return false;','btnSilverOver(this);')}" onmouseout="btnSilverOut(this);" onclick="{!IF(!activeBtnAbort || isReadOnlyAdmin,'return false;','waitOn();abortCalculation();')}">
                                            <apex:outputPanel layout="inline" styleClass="btn_silver">
                                                <apex:outputPanel layout="inline" styleClass="btn_silver_r">
                                                    <span class="a_btn_silver a_btn_silver_blue">{!$Label.xactlyexpress__StopCalc}</span>                                                  
                                                </apex:outputPanel>
                                            </apex:outputPanel>
                                        </apex:outputPanel>                                         
                        </div>
                        <div style="width:300px;float:right;">
                                        <apex:outputPanel layout="block" styleClass="btn_silver_wrapper" onmouseover="btnSilverOver(this);" onmouseout="btnSilverOut(this);" onclick="displayTableUndoOptions();">
                                            <apex:outputPanel layout="inline" styleClass="btn_silver">
                                                <apex:outputPanel layout="inline" styleClass="btn_silver_r">
                                                    <span id="btn_lbl_made_a_mistake_steps" class="a_btn_silver a_btn_silver_blue">{!$Label.MadeAMistake}</span>                                                  
                                                    <span id="btn_lbl_hide_options_steps" style="display:none;" class="a_btn_silver a_btn_silver_blue">{!$Label.hideOptions}</span>
                                                </apex:outputPanel>
                                            </apex:outputPanel>
                                        </apex:outputPanel>
                                        <apex:outputPanel layout="block" styleClass="btn_silver_wrapper" onmouseover="btnSilverOver(this);" onmouseout="btnSilverOut(this);" onclick="manageViewLogTable();">
                                            <apex:outputPanel layout="inline" styleClass="btn_silver">
                                                <apex:outputPanel layout="inline" styleClass="btn_silver_r">
                                                    <span id="viewLogBtn" class="a_btn_silver a_btn_silver_blue">{!$Label.ShowOldLogs}</span>
                                                </apex:outputPanel>
                                            </apex:outputPanel>
                                        </apex:outputPanel>
                                         
                        </div>
                        
                    </div>
                    <!-- NEW UI EXTRA BUTTONS END -->
                    
                </apex:outputPanel>

                <!-- NEW UI END -->
                
                <apex:outputPanel id="LogsAndUndoWrapper">
                    <input type="hidden" id="LogsAndUndoLoaded" value="{!showLogsAndUndo}" />
                    <apex:outputPanel rendered="{!showLogsAndUndo}" layout="block" styleClass="idLogsAndUndo">
                 <div class="floatTable" style="{!IF(showLogs || showUndoOptions, '', 'display:none;')}">
                    <div id="selectedPanel" style="{!IF(showLogs, 'margin-left:630px;', 'margin-left:460px;')}"></div>
                    <div class="topFloatTable"></div>
                    <div class="floatContent">
                        <div style="margin-left:10px;">
                        <!--begin table  make a mistake-->
                     <apex:outputpanel layout="none" id="tableUndo">
                     <div id="tableUndoOptions" style="{!IF(showUndoOptions, '', 'display:none;')}">
                     <div class="tablewrapper"  style="margin-top:0;margin-left:0px;width:100%;">
                         <div id="tableContent" style="width: 703px;">  
                              <table width="703px" cellspacing="0" id="generalTable">
                                     <tr class="even generalTableTh">
                                       <th colspan="6" style="text-align:left;padding-left:30px;">{!$Label.ProceedWithCaution}.</th>
                                     </tr>
                                     <tr style="background:white;">
                                       <td colspan="2">
                                            <apex:outputPanel layout="block" style="margin-left:78px;" styleClass="btn_c_wrapper btn_action {!IF( isReadOnlyAdmin || runningProcess || (!activeBtnUndoFinalize && !activeBtnUndoRelease && !activeBtnUndoCalculation), 'disabledOpacityButton', '')}" onmouseover="{!IF( isReadOnlyAdmin || runningProcess || (!activeBtnUndoFinalize && !activeBtnUndoRelease && !activeBtnUndoCalculation), 'return false;', '')}jQuery(jQuery(this).find('.btn_c')[0]).addClass('btn_red_bg_up');jQuery(jQuery(this).find('.btn_c')[0]).removeClass('btn_red_bg');jQuery(jQuery(this).find('.btn_c_r')[0]).addClass('btn_red_r_bg_up');jQuery(jQuery(this).find('.btn_c_r')[0]).removeClass('btn_red_r_bg');" onmouseout="{!IF(isReadOnlyAdmin || runningProcess || (!activeBtnUndoFinalize && !activeBtnUndoRelease && !activeBtnUndoCalculation), 'return false;', '')}jQuery(jQuery(this).find('.btn_c')[0]).removeClass('btn_red_bg_up');jQuery(jQuery(this).find('.btn_c')[0]).addClass('btn_red_bg');jQuery(jQuery(this).find('.btn_c_r')[0]).removeClass('btn_red_r_bg_up');jQuery(jQuery(this).find('.btn_c_r')[0]).addClass('btn_red_r_bg');" onclick="{!IF(isReadOnlyAdmin || runningProcess || (!activeBtnUndoFinalize && !activeBtnUndoRelease && !activeBtnUndoCalculation), 'return false;', '')}actionNV(this, 'undoAllSteps');">
                                                <apex:outputPanel layout="inline" styleClass="btn_c btn_red_bg">
                                                    <apex:outputPanel layout="inline" styleClass="btn_c_r btn_red_r_bg">
                                                        <span class="font_btn_green"><div class="text_wp_btn1">{!$Label.xactlyexpress__UndoAllSteps}</div></span>
                                                    </apex:outputPanel>
                                                </apex:outputPanel>
                                            </apex:outputPanel>
                                       </td>
                                       <td>
                                           <apex:outputpanel layout="none" rendered="{!multipleStepsType == MULTIPLE_STEPS_UNDO_ALL_STEPS}">
                                                <div class="swirly" style="display:{!IF(multipleStepsStatus=='Queued' || multipleStepsStatus=='Running','block;','none;')}"><img src="{!URLFOR($Resource.XactlySMBResources, 'img/icons/loader2.gif')}" width="32" height="32"/></div>
                                           </apex:outputpanel>
                                       </td>
                                       <td colspan="2">
                                           <apex:outputpanel layout="none" rendered="{!multipleStepsType == MULTIPLE_STEPS_UNDO_ALL_STEPS}">
                                                {!multipleStepsMsg}
                                           </apex:outputpanel>
                                       </td>
                                     </tr>
                                     <tr class="even">
                                        <td style="width:10%">
                                            <div class="cellPadding fontbold">{!$Label.step} 1</div>
                                        </td>
                                        <td style="width:40%">
                                            <apex:outputPanel layout="block" styleClass="btn_silver_wrapper btn_action {!IF(isReadOnlyAdmin || runningProcess || !activeBtnUndoFinalize, 'disabledOpacityButton', '')}" onmouseover="{!IF(isReadOnlyAdmin || runningProcess || !activeBtnUndoFinalize, 'return false;', '')}btnSilverOver(this);" onmouseout="{!IF(isReadOnlyAdmin || runningProcess || !activeBtnUndoFinalize, 'return false;', '')}btnSilverOut(this);" onclick="{!IF(isReadOnlyAdmin || runningProcess || !activeBtnUndoFinalize, 'return false;', '')}actionNV(this, 'unfinalizePayments');">
                                                <apex:outputPanel layout="inline" styleClass="btn_silver">
                                                    <apex:outputPanel layout="inline" styleClass="btn_silver_r">
                                                        <span class="a_btn_silver a_btn_silver_blue"><div class="text_wp_btn2">{!$Label.xactlyexpress__UndoL}: {!$Label.xactlyexpress__FinalizePaymentFinished}</div></span>
                                                    </apex:outputPanel>
                                                </apex:outputPanel>
                                            </apex:outputPanel>
                                        </td>
                                        <td style="width:10%;border-right:solid 3px #DAD9DB">
                                            <div class="swirly"><img src="{!URLFOR($Resource.XactlySMBResources, 'img/icons/loader2.gif')}" width="32" height="32"/></div>
                                        </td>
                                        <td style="width:30%">
                                            <apex:outputPanel layout="block" styleClass="btn_silver_wrapper btn_action {!IF(isReadOnlyAdmin || runningProcess || !activeBtnDeleteManualAdjs, 'disabledOpacityButton', '')}" onmouseover="{!IF(isReadOnlyAdmin || runningProcess || !activeBtnDeleteManualAdjs, 'return false;', '')}btnSilverOver(this);" onmouseout="{!IF(isReadOnlyAdmin || runningProcess || !activeBtnDeleteManualAdjs, 'return false;', '')}btnSilverOut(this);" onclick="{!IF(isReadOnlyAdmin || runningProcess || !activeBtnDeleteManualAdjs, 'return false;', '')}actionNV(this, 'deleteManualAdjustments');">
                                                <apex:outputPanel layout="inline" styleClass="btn_silver">
                                                    <apex:outputPanel layout="inline" styleClass="btn_silver_r">
                                                        <span class="a_btn_silver a_btn_silver_blue"><div class="text_wp_btn2">{!$Label.xactlyexpress__DeleteManualAdjustments}</div></span>
                                                    </apex:outputPanel>
                                                </apex:outputPanel>
                                            </apex:outputPanel>
                                        </td>
                                        <td style="width:10%">
                                            <div class="swirly"><img src="{!URLFOR($Resource.XactlySMBResources, 'img/icons/loader2.gif')}" width="32" height="32"/></div>
                                        </td>
                                     </tr>
                                     
                                     <tr class="odd">
                                        <td style="width:10%">
                                            <div class="cellPadding fontbold">{!$Label.step} 2</div>
                                        </td>
                                        <td style="width:40%">
                                            <apex:outputPanel layout="block" styleClass="btn_silver_wrapper btn_action {!IF(isReadOnlyAdmin || runningProcess || !activeBtnUndoRelease || finalizeStatus!=$Label.xactlyexpress__NotCalculated || commStmtStatus!=$Label.xactlyexpress__NotCalculated, 'disabledOpacityButton', '')}" onmouseover="{!IF(isReadOnlyAdmin || runningProcess || !activeBtnUndoRelease || finalizeStatus!=$Label.xactlyexpress__NotCalculated || commStmtStatus!=$Label.xactlyexpress__NotCalculated, 'return false;', '')}btnSilverOver(this);" onmouseout="{!IF(isReadOnlyAdmin || runningProcess || !activeBtnUndoRelease || finalizeStatus!=$Label.xactlyexpress__NotCalculated || commStmtStatus!=$Label.xactlyexpress__NotCalculated, 'return false;', '')}btnSilverOut(this);" onclick="{!IF(isReadOnlyAdmin || runningProcess || !activeBtnUndoRelease || finalizeStatus!=$Label.xactlyexpress__NotCalculated || commStmtStatus!=$Label.xactlyexpress__NotCalculated, 'return false;', '')}actionNV(this, 'undoReleases');">
                                                <apex:outputPanel layout="inline" styleClass="btn_silver">
                                                    <apex:outputPanel layout="inline" styleClass="btn_silver_r">
                                                        <span class="a_btn_silver a_btn_silver_blue"><div class="text_wp_btn2">{!$Label.xactlyexpress__UndoL}: {!$Label.xactlyexpress__Release}</div></span>
                                                    </apex:outputPanel>
                                                </apex:outputPanel>
                                            </apex:outputPanel>
                                        </td>
                                        <td style="width:10%;border-right:solid 3px #DAD9DB">
                                            <div class="swirly" style="display:{!IF(toUndoReleaseLog.process.status__c=='Queued' || toUndoReleaseLog.process.status__c=='Running','block;','none;')}"><img src="{!URLFOR($Resource.XactlySMBResources, 'img/icons/loader2.gif')}" width="32" height="32"/></div>
                                        </td>
                                        <td style="width:30%">
                                            &nbsp;
                                        </td>
                                        <td style="width:10%">
                                            &nbsp;
                                        </td>
                                     </tr>

                                     <tr class="even">
                                        <td style="width:10%">
                                            <div class="cellPadding fontbold">{!$Label.step} 3</div>
                                        </td>
                                        <td style="width:40%">
                                            <apex:outputPanel layout="block" styleClass="btn_silver_wrapper btn_action {!IF(isReadOnlyAdmin || runningProcess || !activeBtnUndoCalculation || finalizeStatus!=$Label.xactlyexpress__NotCalculated || commStmtStatus!=$Label.xactlyexpress__NotCalculated || releaseStatus !=$Label.xactlyexpress__NotCalculated, 'disabledOpacityButton', '')}" onmouseover="{!IF(isReadOnlyAdmin || runningProcess || !activeBtnUndoCalculation || finalizeStatus!=$Label.xactlyexpress__NotCalculated || commStmtStatus!=$Label.xactlyexpress__NotCalculated || releaseStatus !=$Label.xactlyexpress__NotCalculated, 'return false;', '')}btnSilverOver(this);" onmouseout="{!IF(isReadOnlyAdmin || runningProcess || !activeBtnUndoCalculation|| finalizeStatus!=$Label.xactlyexpress__NotCalculated || commStmtStatus!=$Label.xactlyexpress__NotCalculated || releaseStatus !=$Label.xactlyexpress__NotCalculated, 'return false;', '')}btnSilverOut(this);" onclick="{!IF(isReadOnlyAdmin || runningProcess || !activeBtnUndoCalculation || finalizeStatus!=$Label.xactlyexpress__NotCalculated || commStmtStatus!=$Label.xactlyexpress__NotCalculated || releaseStatus !=$Label.xactlyexpress__NotCalculated, 'return false;', '')}actionNV(this, 'runClearResult');">
                                                <apex:outputPanel layout="inline" styleClass="btn_silver">
                                                    <apex:outputPanel layout="inline" styleClass="btn_silver_r">
                                                        <span class="a_btn_silver a_btn_silver_blue"><div class="text_wp_btn2">{!$Label.xactlyexpress__UndoL}: {!DealsAndPaymentLabel}</div></span>
                                                    </apex:outputPanel>
                                                </apex:outputPanel>
                                            </apex:outputPanel>
                                        </td>
                                        <td style="width:10%;border-right:solid 3px #DAD9DB">
                                            <div class="swirly" style="display:{!IF(toCleanResult.process.status__c=='Queued' || toCleanResult.process.status__c=='Running','block;','none;')}"><img src="{!URLFOR($Resource.XactlySMBResources, 'img/icons/loader2.gif')}" width="32" height="32"/></div>
                                        </td>
                                        <td style="width:30%">
                                            &nbsp;
                                        </td>
                                        <td style="width:10%">
                                            &nbsp;
                                        </td>
                                     </tr>
                                     
                               </table>
                           </div>
                      </div>
                  </div>
                 
            </apex:outputpanel>
                          <!-- end table make a mistake -->
                          
                          <!-- Begin log  -->
                           <apex:outputPanel layout="block" id="loginTable" styleClass="content" style="{!IF(showLogs, '', 'display:none;')}min-height:410px;width: 703px;float:none !important;">            
                            <apex:outputPanel layout="block" style="width: 703px; margin: auto;height: 425px;"> 
                            <div style="width:703px;margin-bottom:0px;">
                                <div class="topTable"></div> 
                       <apex:outputPanel id="alphabeticalBox" styleClass="tableContainer" layout="block" style="min-height:415px">                
                        
                            
                            <apex:dataTable value="{!lastProcesses}" var="iter" id="profilesTable" styleClass="commonTable" border="0" style="border:0;width:100%" rowClasses="odd,even" headerClass="odd" width="100%">
                                 
                                <apex:column >
                                   
                                    <div class="processInformation">
                                        <apex:outputtext value="{!$Label.xactlyexpress__CalculationTime}" />&nbsp;:&nbsp;&nbsp;<apex:outputtext value="{!iter.processDate}" /><br />
                                       
                                         <apex:outputpanel layout="none" rendered="{!IF(iter.process.XactlyExpress__Type__c ='Release',true,false)}" >
                                           <apex:outputtext value="{!$Label.xactlyexpress__Success}" />                                            
                                            :&nbsp;&nbsp;<apex:outputtext value="{!iter.releasesSuccess}" /><br />
                                           <apex:outputtext value="{!$Label.xactlyexpress__Errors}" />
                                            :&nbsp;&nbsp;<apex:outputtext value="{!iter.releasesFailed}" /><br />
                                        </apex:outputpanel>
                                        
                                        
                                        <apex:outputpanel layout="none" rendered="{!IF(iter.process.XactlyExpress__Type__c='Finalize Payment' || iter.process.XactlyExpress__Type__c ='Release',false,true)}" >
                                           <apex:outputtext value="{!IF(iter.process.XactlyExpress__Type__c='Credit',$Label.xactlyexpress__DealsProcessed,$Label.xactlyexpress__CreditsProcessed)}" >
                                               <apex:Param value="{!IF(iter.process.XactlyExpress__Type__c='Credit',currentSettings.dealsPluralCap,currentSettings.creditsPluralCap)}"/>
                                           </apex:outputtext> :&nbsp;&nbsp;<apex:outputtext value="{!iter.dealsProcessed}" /><br />
                                        </apex:outputpanel> 
                                        <apex:outputpanel layout="none" rendered="{!IF(iter.process.XactlyExpress__Type__c ='Release',false,true)}" >
                                            <apex:outputtext value="{!$Label.xactlyexpress__PayeesProcessed}" /> :&nbsp;&nbsp;<apex:outputtext value="{!iter.payeesProcessed}" /><br />
                                        </apex:outputpanel>
                                            <div class="planProcessed">
                                                <apex:repeat value="{!iter.plansProcessed}" var="iterPlan">
                                                    <pre>{!iterPlan.name}</pre>&nbsp;&nbsp;<apex:outputtext value="{!iterPlan.FiscalYear}" /><br />
                                                </apex:repeat>
                                            </div>
                                    </div>
                                    
                                </apex:column>  
                                
                                <apex:column styleClass="processStatusTD">
                                     <div class="processStatus {!IF(iter.fail, 'calculationFail', '')}">
                                         <apex:outputtext value="{!IF(iter.process.XactlyExpress__Type__c='Credit',$Label.xactlyexpress__Crediting,IF(iter.process.XactlyExpress__Type__c='Clean Result',$Label.xactlyexpress__CleanResults,IF(iter.process.XactlyExpress__Type__c='Release',$Label.xactlyexpress__Release,IF(iter.process.XactlyExpress__Type__c=='Finalize Payment',$Label.xactlyexpress__FinalizePaymentFinished,IF(iter.process.XactlyExpress__Type__c=='Gen Comm Stmt',commnStmtLabel,IF(iter.process.XactlyExpress__Type__c=='Post',$Label.xactlyexpress__Calculation,IF(iter.process.XactlyExpress__Type__c='UndoRelease',$Label.xactlyexpress__UndoRelease,iter.process.XactlyExpress__Type__c)))))))} {!iter.process.XactlyExpress__Status__c}" /> <apex:outputtext value=" {!IF(iter.process.XactlyExpress__Type__c="Release" && iter.releasesFailed > 0 , $Label.xactlyexpress__withErrors , '')}" /> 
                                         <apex:outputpanel layout="block" rendered="{!iter.fail}">
                                            <apex:outputtext value="{!iter.process.XactlyExpress__ErrorMsg__c}" /> 
                                         </apex:outputpanel>
                                     </div>
                                </apex:column>      
                                         
                            </apex:dataTable>
                        </apex:outputPanel> 
                      
                        <div class="bottomTable"></div>
                        <div class="btnToCenter btnAction" style="float:right;margin:5px;">                               
                            <div class="btnToCenter btnAction" style="float:left;margin:5px;">         
                            
                        </div>
                        </div>         
                    </div>                   
                   </apex:outputPanel> 
                    <input type="text" style="display:none;" id="loginTable" value="{!$Component.loginTable}" />
                      
                </apex:outputPanel><!-- END CONTENT -->
                          
                          <!-- end log -->
                        </div>
                    </div>
                    <div class="bottomFloatTable"></div>
                 </div>    
                    </apex:outputPanel>
                </apex:outputPanel>
                <div style="width:665px; margin:auto;margin-bottom:0px;"></div>    
            <div style="clear:both"></div>               
            </apex:outputPanel><!-- END CONTENTWRAPPER -->
            </div>
 
            <apex:inputText value="{!customBatchSize}" id="batchSizeInput" styleClass="AUTOMBatchSizeInput" style="display:none;" maxlength="20" />
            <apex:inputText value="{!confgLargePlan}" id="confgLargePlan" styleClass="AUTOMconfgLargePlanInput" style="display:none" maxlength="20" />
            <apex:inputText value="{!isAProcessRunning}" id="isAProcessRunning" style="display:none" />
  
            <c:XactlySMBFooter isReadOnlyAdmin="{!isReadOnlyAdmin}" packageVersion="{!packageVersion}" showPrevious="true" showNext="true" showSave="false" showRefresh="false" showExport="false"/>
            <!-- FOOTER  -->
            <apex:actionFunction name="refresh" action="{!refresh}" rerender="mainContent,errorMsg" oncomplete="posRefresh(false);"/>
            <apex:actionFunction name="setBatchSize" action="{!setBatchSize}" rerender="batchSizeInput,errorMsg" oncomplete="waitOff();"/>
            <apex:actionFunction name="setLargePlans" action="{!setLargePlans}" rerender="confgLargePlan,errorMsg" oncomplete="waitOff();" />

            <apex:actionFunction name="startRunAllSteps" action="{!startRunAllSteps}" rerender="mainContent,errorMsg" oncomplete="posRefresh(false);"/>
            <apex:actionFunction name="startUndoAllSteps" action="{!startUndoAllSteps}" rerender="mainContent,errorMsg" oncomplete="posRefresh(false);"/>
            <apex:actionFunction name="startRunCreditPayment" action="{!startRunCreditPayment}" rerender="mainContent,errorMsg" oncomplete="posRefresh(false);"/>

            <apex:actionFunction name="abortCalculation" action="{!abortCalculation}" rerender="mainContent,errorMsg" oncomplete="posRefresh(false);"/>
         
            <apex:actionFunction name="finalizePayment" action="{!finalizePayment}" rerender="mainContent,errorMsg" oncomplete="posRefresh(false);"/>
            <apex:actionFunction name="runReundoReleases" action="{!runReundoReleases}" rerender="mainContent,errorMsg" oncomplete="posRefresh(false);"/>
            <apex:actionFunction name="runCalculation" action="{!runCalculation}" rerender="mainContent,errorMsg" oncomplete="posRefresh(false);"/>
              
            <apex:actionFunction name="runCreditCalculate" action="{!runCreditCalculate}" rerender="mainContent,errorMsg" oncomplete="posRefresh(false);"/>
            <apex:actionFunction name="runClearResult" action="{!runClearResult}" rerender="mainContent,errorMsg" oncomplete="posRefresh(false);" />
            <apex:actionFunction name="deleteManualAdjustments" action="{!onDeleteCurrentPeriodManualAdjustments}" rerender="mainContent,errorMsg" oncomplete="posRefresh(false);"/>
            <apex:actionFunction name="unfinalizePayment" action="{!unfinalizePayment}" rerender="mainContent,errorMsg" oncomplete="posRefresh(false);"/>
            <apex:actionFunction name="undoReleases" action="{!undoReleases}" rerender="mainContent,errorMsg" oncomplete="posRefresh(false);"/>
              
            <apex:actionFunction name="loadLogsAndUndo" action="{!dummy}" oncomplete="completeLoadLogsAndUndo();" rerender="LogsAndUndoWrapper">
                <apex:param assignTo="{!showLogsAndUndo}" value="true" name="LogsAndUndo" />
            </apex:actionFunction>
            <apex:actionFunction name="checkIfProcessIsAlreadyRunning" action="{!checkIfProcessIsAlreadyRunning}" rerender="isAProcessRunning" oncomplete="executeStep(step);"/>
            <apex:actionfunction id="chatterLoader" name="loadChatter" action="{!loadChatter}" rerender="chatter" oncomplete="waitOff();initChatter();jQuery('.innerOcultar a').click();"/>
        </apex:form>
        <input type="text" style="display:none;" id="label_info_run_att" value="{!$Label.infoRunAtt}" />
        <input type="text" style="display:none;" id="terminology_credit_plural" value="{!currentSettings.creditsPlural}" />
        <input type="text" style="display:none;" id="terminology_deals" value="{!currentSettings.deals}" />
        <input type="text" style="display:none;" id="terminology_quotas" value="{!currentSettings.quotas}" />
        <input type="text" style="display:none;" id="terminology_credits" value="{!currentSettings.credits}" />
        <input type="text" style="display:none;" id="terminology_credit_cap" value="{!currentSettings.creditsCap}" />
        <input type="text" style="display:none;" id="terminology_credit_plural_cap" value="{!currentSettings.creditsPluralCap}" />
        <input type="text" style="display:none;" id="label_info_run_releases" value="{!$Label.infoRunReleases}" />
        <input type="text" style="display:none;" id="label_info_run_payment" value="{!$Label.infoRunPayment}" />
        <input type="text" style="display:none;" id="page_calculate_step_3" value="{!$Page.XactlySMBCalculateStep3}" />
        <input type="text" style="display:none;" id="page_calculate_manage_att" value="{!$Page.XactlySMBCalculateManageAttainments}" />
        <input type="text" style="display:none;" id="label_want_reprocess_releases" value="{!$Label.wantReprocessReleases}" />
        <input type="text" style="display:none;" id="label_confirm_undo_all_steps" value="{!$Label.confirmUndoAllSteps}" />
        <input type="text" style="display:none;" id="label_want_delete_calculations" value="{!$Label.wantDeleteCalculationsReleases}" />
        <input type="text" style="display:none;" id="label_want_delete_manual_adjustment" value="{!$Label.wantDeleteManualAdjustments}" />
        <input type="text" style="display:none;" id="label_want_unfinalize_payment" value="{!$Label.wantUnfinalizePayment}" />
        <input type="text" style="display:none;" id="label_want_delete_releases" value="{!$Label.wantDeleteReleases}" />
        <input type="text" style="display:none;" id="label_hide_old_logs" value="{!$Label.HideOldLogs}" />
        <input type="text" style="display:none;" id="label_show_old_logs" value="{!$Label.ShowOldLogs}" />
        <input type="text" style="display:none;" id="label_set_batch_size_default" value="{!$Label.SetBatchSizeDefault}" />
        <input type="text" style="display:none;" id="label_learn_howto_schedule" value="{!$Label.LearnHowtoSchedule}" />
        <input type="text" style="display:none;" id="label_another_calculation_step_is_running" value="{!$Label.AnotherCalculationStepIsRunning}" />
    </div>
    <c:XactlySMBFooterScript isChatterEnabled="{!isChatterEnabled}" loadPerformantJs="true" loadHeaderJs="true" />
    <apex:stylesheet value="{!URLFOR($Resource.XactlyExpress__XactlySMBResources ,'pages/css/XactlySMBCalculateCalculate.css')}" />
    <script type="text/javascript" language="javascript" src="{!URLFOR($Resource.XactlySMBResources, 'pages/js/XactlySMBCalculateCalculate.js')}"></script>
    <c:XactlySMBFeedbackTab />
</apex:page>
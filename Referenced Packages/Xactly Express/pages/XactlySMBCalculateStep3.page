<!--
    Developed by Timba Software Corp. www.timbasoftware.com admin@timbasoftware.com
    This page lists and manage deals
    @author Dario Levy <dlevy@timbasoftware.com>
    -->
    <apex:page id="manageDeals" controller="XactlyExpress.XactlySMBCalculateStep3" sidebar="false" showHeader="false" standardStylesheets="true" action="{!action}">
    <c:XactlySMBCursor />
    <title>{!titleLabel}</title>
    <!-- PAGE WRAPPER -->
    <div class="pageContent" id="pContent">
        <!-- HEADER -->
            
        <apex:form id="theForm">
            <apex:inputHidden id="selectedIndexHidden" value="{!selectedIndex}" />
            <apex:outputPanel layout="block" id="clearResultStatus" style="display: none;">
                <apex:inputHidden id="clearResultStatusHidden" value="{!clearResultStatus}" /> 
            </apex:outputPanel>
            
            <apex:outputPanel layout="block" styleClass="header">
                <c:XactlySMBHeader id="XactlySMBHeader" isAdmin="{!isAdmin}"  isActive="{!isActive}" nbrSeparator="{!nbrSeparator}" nbrDecimal="{!nbrDecimal}" currentUserOrSlected="{!currentUserOrSlected}" emulatingUserURLAppend="{!emulatingUserURLAppend}" wqlabel="{!currentSettings.quotasPluralCap}" wclabel="{!currentSettings.creditsPluralCap}" wlabel="{!currentSettings.dealsPluralCap}" step="2" wtype="calculate"  hlabel="{!ManageDealsTitleLabel}" stepHelp="CalculateStep3" showPrevious="true" showNext="true" showSave="true" showRefresh="true" showExport="false" selected="1" selectedLevel2="2"  selectedLevel3="2"/>
            </apex:outputPanel>
            
            <div id="shadowContainer" class="shadowContainer">
            <apex:outputpanel layout="block" id="chatter" styleClass="additionalContent" rendered="{!isAdmin && isActive}">
				<c:XactlySMBChatterWall objectId="{!$User.Id}" showHeader="true" showWall="true" currentPage="{!$CurrentPage.Name}" chatterCurrentUserImageUrl="{!chatterCurrentUser_ImageUrl}" rendered="{!isChatterEnabled && isChatterLoaded}"/>
	        </apex:outputpanel>
            <!-- MAIN CONTENT -->
            <apex:outputPanel layout="block" styleClass="mainContent" id="mainContent" rendered="{!isAdmin}">
                <!-- CONTENT -->
                <div class="content">
                    <apex:outputPanel id="errorMsg" layout="block" styleClass="errorScrollBox">
                        <apex:outputPanel layout="block" rendered="{!errorMsg!=''}">
                            <div id="errorContainer"><c:XactlySMBErrorMsg error="{!errorMsg}" errStyle="background:#FF0000;color:#FFFFFF;font-size:16px;font-weight:bold;overflow:auto;max-height:100px;"/></div>
                        </apex:outputPanel>
                    </apex:outputPanel>   
                    <div>
                        <apex:outputPanel layout="block" styleClass="actionButtons" rendered="{!Views.size > 0}">
                            <apex:outputText styleclass="areaTitle" value="{!$Label.xactlyexpress__selectView}"/>
                            <span style="min-width:200px;max-width:200px;overflow:hidden;"><apex:selectList id="viewDrpdwn" styleClass="viewDrpdwn" onclick="checkEditing();" onchange="resetWidthDDown(this, '200px');if(!checkEditing()){return false;};waitOn();window.location.href='{!$Page.XactlyExpress__XactlySMBCalculateStep3}?vwId='+this.value" value="{!dummyString}" size="1" multiselect="false" onblur="resetWidthDDown(this, '200px');" onmousedown="setWidthToAutoDDown(this);">
                                <apex:selectOptions value="{!Views}"/> 
                            </apex:selectList></span>  
                        </apex:outputpanel>
                        <apex:outputPanel id="contentButtons" layout="block" >
                            <apex:outputPanel id="newDealdiv" layout="block" >
                               <div class="xactlyBtnRectWrapper {!IF(OR(statusProcces==PROCESS_STATUS_RUNNING,statusProcces==PROCESS_STATUS_Queued,!isSalesAdmin),'disabledOpacityButton','')}" id="newDealButton" onmouseover="xactlyBtnRectMouseOver(this);" onmouseout="xactlyBtnRectMouseOut(this);" onclick="{!IF(OR(statusProcces==PROCESS_STATUS_RUNNING,statusProcces==PROCESS_STATUS_Queued,!isSalesAdmin),'return false;','')}if(!checkEditing()){return false;};waitOn();window.location.href='{!$Page.XactlySMBDealDetails}{!IF(!ISNULL(currentView.id),'?vwId='+currentView.id,'')}{!IF(doingSearch,'?s='+URLENCODE(searchstring),'')}';">
                                      <div class="xactlyBtnRect">
                                          <div class="xactlyBtnRectBackground">
                                              <div class="middleOffMouse xactlyBtnRectMiddle" >
                                                 <div class="rigthOffMouseBtn xactlyBtnRectRight" >
                                                        <div class="xactlyBtnRectTextWrapper xactlyBtnRectLabel" style="">  
                                                               <apex:outputtext escape="false" value="{!$Label.xactlyexpress__newDeal}">
                                                                    <apex:Param value="{!currentSettings.dealsCap}"/>
                                                                </apex:outputtext>
                                                        </div>
                                                 </div>
                                              </div>                                                                            
                                          </div>
                                      </div>                                                                  
                                   </div>  
                                
                            </apex:outputPanel>
                            
                            <apex:outputPanel id="delDealdiv" layout="block"  rendered="{!searchstring=''}">
                              
                                <a id="deleteAllDealsLink"  onclick="confirmDeleteAll();" ></a>
                                <div class="xactlyBtnRectWrapper {!IF(OR(statusProcces==PROCESS_STATUS_RUNNING,statusProcces==PROCESS_STATUS_Queued,!isSalesAdmin),'disabledOpacityButton','')}" id="deleteDealsButton" onclick="{!IF(OR(statusProcces==PROCESS_STATUS_RUNNING,statusProcces==PROCESS_STATUS_Queued,!isSalesAdmin),'return false;','')}jQuery('#deleteAllDealsLink').click();" onmouseover="xactlyBtnRectMouseOver(this);" onmouseout="xactlyBtnRectMouseOut(this);">
                                  <div class="xactlyBtnRect">
                                      <div class="xactlyBtnRectBackground">
                                          <div class="middleOffMouse xactlyBtnRectMiddle" >
                                             <div class="rigthOffMouseBtn xactlyBtnRectRight" >
                                                    <div class="xactlyBtnRectTextWrapper xactlyBtnRectLabel">  
                                                           <apex:outputText value="{!IF(OR(statusProcces==PROCESS_STATUS_RUNNING,statusProcces==PROCESS_STATUS_Queued),$Label.xactlyexpress__deletingAll,$Label.xactlyexpress__DeleteAllDeals)}"> 
                                                                <apex:Param value="{!currentSettings.dealsPluralCap}"/>
                                                            </apex:outputtext>
                                                    </div>
                                             </div>
                                          </div>                                                                            
                                      </div>
                                  </div>
                                </div>       
                              
                            </apex:outputPanel>
                            <apex:outputPanel id="delButnWrapperDiv">
	                            <!--disabled delete button-->
	                            <div class="xactlyBtnRectWrapper" id="disabledButn" style="display:inline-block;height:0px;margin-top:15px;margin-left:30px;opacity:0.5;">
	                                <div class="xactlyBtnRect">
	                                      <div class="xactlyBtnRectBackground">
		                                      <div class="middleOffMouse xactlyBtnRectMiddle" style="cursor:default">
		                                             <div class="rigthOffMouseBtn xactlyBtnRectRight" style="cursor:default">
		                                                    <div class="xactlyBtnRectTextWrapper xactlyBtnRectLabel">
		                                                        <apex:outputText value="{!$Label.xactlyexpress__DeleteSelectedDeal}"/>
		                                                    </div>
		                                             </div>
		                                       </div>
	                                      </div>
	                                 </div>
	                            </div>
	                            <!--delete selected button-->
	                            <apex:outputPanel id="delSelectedDealdiv" layout="block"  style="display:inline-block;margin-left:30px;height:0px;margin-top:15px;">
	                                <div class="xactlyBtnRectWrapper {!IF(OR(statusProcces==PROCESS_STATUS_RUNNING,statusProcces==PROCESS_STATUS_Queued),'disabledOpacityButton','')}" id="deleteSelectedDealsButton" onclick="confirmDeleteSelected();" onmouseover="xactlyBtnRectMouseOver(this);" onmouseout="xactlyBtnRectMouseOut(this);" style="display:none">
	                                  <div class="xactlyBtnRect">
	                                      <div class="xactlyBtnRectBackground">
	                                          <div class="middleOffMouse xactlyBtnRectMiddle">
	                                             <div class="rigthOffMouseBtn xactlyBtnRectRight" >
	                                                    <div class="xactlyBtnRectTextWrapper xactlyBtnRectLabel">  
	                                                           <apex:outputText value="{!$Label.xactlyexpress__DeleteSelectedDeal}"> 
	                                                                <apex:Param value="{!currentSettings.dealsPluralCap}"/>
	                                                            </apex:outputtext>
	                                                    </div>
	                                             </div>
	                                          </div>                                                                            
	                                      </div>
	                                  </div>
	                                </div>       
	                            </apex:outputPanel>
	                        </apex:outputPanel>  
                             
                        </apex:outputPanel>
                        
                        <div id="delProgressBar" style="width: 130px;height: 20px;position: absolute;top: 20px;left: 684px;display: none;">
                           <img id="progressBar" src="{!URLFOR($Resource.XactlySMBResources, 'img/icons/progressBar.gif')}" />
                        </div>
                        
                         <apex:outputPanel id="searchbutton" styleClass="searchbutton" layout="block" style="margin-top:0px">                                                       
                         <div class="xactlyBtnRectWrapper" id="searchButtonDivEnable" onmouseover="xactlyBtnRectMouseOver(this);" onmouseout="xactlyBtnRectMouseOut(this);">
                                   <div class="xactlyBtnRect">
                                       <div class="xactlyBtnRectBackground">
                                            <div class="middleOffMouse xactlyBtnRectMiddle" >
                                                 <div class="rigthOffMouseBtn xactlyBtnRectRight" >
                                                     <div class="xactlyBtnRectTextWrapper xactlyBtnRectLabel" style="">  
                                                            <apex:outputText value="{!$Label.xactlyexpress__Search}"/> 
                                                     </div>
                                                 </div>
                                             </div>                                                                            
                                       </div>
                            </div>
                            </div>
                             <div class="disabledOpacityButton" id="searchButtonDiv">
                                   <div class="xactlyBtnRect">
                                       <div class="xactlyBtnRectBackground">
                                            <div class="middleOffMouse xactlyBtnRectMiddle" >
                                                 <div class="rigthOffMouseBtn xactlyBtnRectRight" style="cursor:default;">
                                                     <div class="xactlyBtnRectTextWrapper xactlyBtnRectLabel" style="cursor:default;">  
                                                            <apex:outputText value="{!$Label.xactlyexpress__Search}"/> 
                                                     </div>
                                                 </div>
                                             </div>                                                                            
                                       </div>
                            </div>
                            </div>                           
                        </apex:outputpanel>
                        <div class="actionButtons" id="actionButtonsDiv" style="margin-top:1px">                 
                            <apex:inputText value="{!searchstring}" id="theTextInput" style="text-align:right;"/>
                        </div>     
                        
                        <div style="clear:both;"></div>
                    </div>
                    <apex:outputPanel id="tableWrapper" styleclass="tableWrapper" layout="block">
                        <input class="hidden" id="labelSearchEmpty" value="{!$Label.SearchEmpty}"/>
			            <input class="hidden" id="labelSearchMaxLimit" value="{!$Label.SearchMaxLimit}"/>
			            <input class="hidden" id="doingSearch" value="{!doingSearch}"/>
			            <input class="hidden" id="searchString" value="{!JSENCODE(searchstring)}"/>
			            <input class="hidden" id="xactlySMBDealDetails" value="{!$Page.XactlySMBDealDetails}"/>
			            <input class="hidden" id="currentViewId" value="{!JSENCODE(currentView.id)}"/>
                        <div class="tHeader">
                            <div id="tHeaderSubdiv">
                                <div id="topLeftCurvy"><img class="img-topLeftCurvy" src="{!URLFOR($Resource.XactlySMBResources ,'img/layout/topLeftCurvy.png')}"/></div>
                                <div class="headerLeftSide">
                                    <a href="{!$Page.XactlySMBCreateEditViews}?sctn=deals" onclick="if(!checkEditing()){return false;};"  style="{!IF(isReadOnlyAdmin,'display:none','')}"><apex:outputText value="{!$Label.xactlyexpress__createNewView} |"/></a>
                                    <apex:outputPanel layout="none" rendered="{!!ISNULL(currentView.id)}">
                                        <a href="{!$Page.XactlySMBCreateEditViews}?sctn=deals&id={!URLENCODE(currentView.id)}"  style="{!IF(isReadOnlyAdmin,'display:none','')}" onclick="if(!checkEditing()){return false;};"><apex:outputText value="{!$Label.xactlyexpress__EditView} |"/></a>
                                        <apex:commandLink id="deleteViewLink"  style="{!IF(isReadOnlyAdmin,'display:none','')}" action="{!deleteView}" onclick="if(confirmDeleteView()){if(!checkEditing()){return false;}}else{return false;};"><apex:outputText value="{!$Label.xactlyexpress__DeleteView} |"/></apex:commandLink>
                                        <a href="{!$Page.XactlySMBCalculateStep3}?vwId={!URLENCODE(currentView.id)}" style="font-weight:bold;" onclick="if(!checkEditing()){return false;}"><apex:outputText value="{!$Label.xactlyexpress__Refresh}"/></a>
                                    </apex:outputPanel>
                                </div>
                                <apex:outputPanel id="filterByLettersCont" layout="block" styleClass="headerRightSide" rendered="{!attrType == 'string' ||  attrType == 'usertype'}">
                                    <apex:repeat value="{!LetterList}" var="iter" id="letters">
                                        <apex:commandLink id="iterLetter" style="{!IF(SL == iter,'background-color:#DEECFC;','')}" action="{!applyFiltersAndGrouping}" onclick="if(!checkEditing()){return false;};waitOn();" value="{!iter}" rerender="tableWrapper,errorMsg,delButnWrapperDiv" oncomplete="initSuperbox();waitOff();fixCelsDimensions();introAsTab();bindSelectiveDealsEvents();loadBubbles();">
                                            <apex:param value="{!iter}" name="SL"/>
                                        </apex:commandLink>
                                    </apex:repeat>
                                    <apex:commandLink id="filterOther" style="{!IF(SL == 'Other','background-color:#DEECFC;','')}" action="{!applyFiltersAndGrouping}" onclick="if(!checkEditing()){return false;};waitOn();" value="{!$Label.xactlyexpress__Other}" rerender="tableWrapper,errorMsg,delButnWrapperDiv" oncomplete="initSuperbox();waitOff();fixCelsDimensions();introAsTab();bindSelectiveDealsEvents();loadBubbles();">
                                        <apex:param value="Other" name="SL"/>
                                    </apex:commandLink>
                                    <apex:commandLink id="filterAll" style="{!IF(SL == 'All','background-color:#DEECFC;','')}" action="{!applyFiltersAndGrouping}" onclick="if(!checkEditing()){return false;};waitOn();" value="{!$Label.xactlyexpress__all}" rerender="tableWrapper,errorMsg,delButnWrapperDiv" oncomplete="initSuperbox();waitOff();fixCelsDimensions();introAsTab();bindSelectiveDealsEvents();loadBubbles();">
                                        <apex:param value="All" name="SL"/>
                                    </apex:commandLink>
                                </apex:outputPanel>
                                <div id="topRightCurvy"><img class="img-topRightCurvy" src="{!URLFOR($Resource.XactlySMBResources ,'img/layout/topRightCurvy.png')}"/></div>
                                <div style="clear:both"></div>
                            </div> 
                        </div>
                        <!--div to include all the info msgs-->
                        <apex:outputPanel id="info-success-div">
	                        <div id="info-div" class="alert alert-block" style="width:90%;margin-left:auto;margin-right:auto;display:none">
	                          <button type="button" class="close" data-dismiss="alert">&times;</button>
	                          <label id="count" style="padding-right:5px"></label><apex:outputText value="{!$Label.xactlyexpress__RowsSelected}"/>
	                          <a id="selectPage" style="padding-right:15px;padding-left:15px"><apex:outputText value="{!$Label.xactlyexpress__SelectEntirePage}"/></a>
	                          <a id="deselectPage" style="padding-right:15px"><apex:outputText value="{!$Label.xactlyexpress__DeselectPage}"/></a>
	                        </div>
	                        <!--end of info div-->
	                        <!--success msg div-->
	                        <apex:outputPanel id="success-div-wrapper" rendered="{!OR(ISNULL(errorMsg),errorMsg=='')}">
		                        <div style="display: block;">
		                            <div id="success-div" class="alert alert-success" style="width:90%;margin-left:auto;margin-right:auto;margin-top: 5px;display:none;">
		                            <button type="button" class="close" data-dismiss="alert">&times;</button>
		                                <label id="delRowCount" style="padding-right:5px"></label>
		                                <apex:outputText value="{!$Label.xactlyexpress__DelSuccessMsg}"/>
		                            </div>
		                        </div>
		                     </apex:outputPanel>
                       </apex:outputPanel>
                        <!--end of success msg div-->                        
                        <div class="tContent" id="tContent">              
                            <apex:outputPanel id="tableContainerContainer" layout="block">                            
                                <apex:outputPanel rendered="{!IF(visibleDeals.size > 0,false,true)}">
                                    <apex:outputText value="{!noDealForThisViewLabel}"/>
                                </apex:outputPanel>
                                
                                <apex:inputHidden id="statusProccesInput" value="{!statusProcces}"/>
                                
                                <apex:outputPanel rendered="{!IF(visibleDeals.size > 0,true,false)}" id="tableContainer" styleClass="tableContainer hideable " layout="block">                                                                
                                    <div class="FixedCelsTable">
                                            <div class="tablesHolder">

                                                <apex:outputPanel id="FixedCelsTableGrid">
                                                    <div id="recordsList" class="recordsList">
                                                        <input type="hidden" id="focusHandler"/>
                                                        <!-- Left Panel -->
                                                        <div id="rowsContainer" class="rows">
                                                            <div id="rowsHeaders" class="rowsHeader even">
                                                                <table border="0"  cellspacing="0" width="100px">
                                                                    <tr class="objectHeaders">
                                                                        <td width="100px"></td>
                                                                    </tr>
                                                                </table>
                                                            </div>
                                                            <div id="rows" class="rowsScroll" style="padding-top:24px;">
                                                                <table border="0" class="rowsTable" cellspacing="0" width="100px">
                                                                    <apex:variable var="iterIndex" value="{!1}"/>
                                                                    <apex:repeat var="d" value="{!visibleDeals}" id="genGadgets">
                                                                        <tr class="dataRow whiteCells rows{!RIGHT(TEXT(iterIndex),2)} {!IF(ISNULL(d.d.id) && mod(d.i,2)==0,'oddNewDealRow',
                                                                            IF(ISNULL(d.d.id) && mod(d.i,2)!=0,'evenNewDealRow',
                                                                            IF(mod(d.i,2)==0 && d.editable,'odd',
                                                                            IF(mod(d.i,2)==0 && !d.editable,'oddNonEditable',
                                                                            IF(d.editable,'even',
                                                                            'evenNonEditable')))))}">
                                                                            <td width="100px" >
                                                                                <div style="width: 100px">
                                                                                    <apex:outputPanel styleClass="actionBtnContainer" layout="block">
                                                                                        <div id="coment{!FLOOR(iterIndex)}" style="cursor:pointer;margin-top:3px;" class="{!IF(d.d.Comment__c==''&&d.d.Comment2__c=='','inteactionIconSprite addCommentLink','inteactionIconSprite editCommentLink')}"  onclick="addComment({!d.i});"></div>                                                                               
                                                                                    </apex:outputPanel>

                                                                                    <div class="actionBtnContainer">
                                                                                        <div id="copy{!FLOOR(iterIndex)}"  onclick="if(!checkEditing()){return false;};waitOn();window.location.href='{!$Page.XactlySMBDealDetails}?cpy={!d.d.id}&vwId={!URLENCODE(currentView.id)}';" style="cursor: pointer;margin-top:1px;">
                                                                                            <div class="inteactionIconSprite copyDeal"></div>
                                                                                            <apex:param value="{!d.i}" name="index"/>
                                                                                        </div>
                                                                                    </div>
                                                                                    <apex:outputPanel rendered="{!d.editable}" style="display:none;" styleclass="actionBtnContainer editingDeal row{!RIGHT(TEXT(iterIndex),2)}" >                                                                                        
                                                                                        <div class="inteactionIconSprite tic" onclick="lockDeal({!RIGHT(TEXT(iterIndex),2)});" style="cursor:pointer;"></div>
                                                                                    </apex:outputPanel>
                                                                                    <apex:outputPanel rendered="{!d.editable}" styleclass="actionBtnContainer rowShow{!RIGHT(TEXT(iterIndex),2)}" >
                                                                                        <div id="editDeal" class="inteactionIconSprite pencilEdit" onclick="editDeal({!RIGHT(TEXT(iterIndex),2)});" style="cursor:pointer; margin:2px 6px 0px 0px;"></div>
                                                                                    </apex:outputPanel>
                                                                                    <apex:outputPanel rendered="{!IF(isReadOnlyadmin,'false','true')}">
                                                                                        <div class="actionBtnContainer">
                                                                                        <apex:outputPanel rendered="{!IF((d.isDisabled),true,false)}">
                                                                                            <input type="checkbox" name="selectedDeals" value="{!d.i}" class="selectedDeals" disabled="true" style="width:13px;height:13px;margin-top:6px;margin-top:4px\9;" />
                                                                                        </apex:outputPanel>
                                                                                        <apex:outputPanel rendered="{!IF(!(d.isDisabled),true,false)}">
                                                                                            <input type="checkbox" name="selectedDeals" value="{!d.i}" class="selectedDeals"  style="width:13px;height:13px;margin-top:6px;margin-top:4px\9;" />
                                                                                        </apex:outputPanel>
                                                                                        </div>
                                                                                    </apex:outputPanel>
                                                                                </div>
                                                                            </td>
                                                                        </tr>
                                                                        <apex:variable var="iterIndex" value="{!iterIndex + 1}"/>
                                                                    </apex:repeat>
                                                                </table>
                                                            </div>
                                                        </div>
                                                        

                                                        <!-- Top Panel -->
                                                        <div id="colsContainer" class="colsContainer">
                                                            <div id="cols"  class="columns">
                                                                <table id="cellsTable" cellspacing="0" border="0">
                                                                    <tr class="objectHeaders even">
                                                                        <apex:repeat var="h" value="{!attrs}" id="genHeadersLinks"> 
                                                                            <td>
                                                                                <div class="titles" style="overflow:hidden;">
                                                                                    <apex:outputPanel rendered="{!sortBy == h.XactlyExpress__DealColumnName__c}" layout="block" style="float:left;margin-top:3px;">
                                                                                       <div class="inteactionIconSprite {!IF(sortByDesc == true,'arrowDown','arrowUp')}"></div>
                                                                                    </apex:outputPanel>
                                                                                    <apex:outputPanel rendered="{!h.XactlyExpress__DealColumnName__c != 'importSource' && h.XactlyExpress__DealColumnName__c != 'SourceID__c'}" layout="block" style="float:left;margin-top:3px;">
                                                                                        <apex:commandLink id="applyFilterLink" action="{!applyFiltersAndGrouping}" onclick="if(!checkEditing() ){return false;};waitOn();" value="{!IF(h.Name == 'Product Id',$Label.xactlyexpress__Product,IF(h.Name == 'Account Id',$Label.xactlyexpress__Account,h.Name))}{!IF(h.XactlyExpress__IsRequired__c, '*','')}" style="float: left; margin-left: 2px;color: #3B6080;font-size:11px;font-weight:bold;text-align:center;white-space:nowrap;" rerender="tableWrapper,errorMsg,delButnWrapperDiv" oncomplete="fixCelsDimensions();introAsTab();waitOff();bindSelectiveDealsEvents();loadBubbles();">
                                                                                            <apex:param value="{!h.XactlyExpress__DealColumnName__c}" name="sb"/>
                                                                                        </apex:commandLink>
                                                                                    </apex:outputPanel>
                                                                                    <apex:outputPanel rendered="{!h.XactlyExpress__DealColumnName__c == 'importSource' || h.XactlyExpress__DealColumnName__c == 'SourceID__c'}" layout="block" style="float:left;margin-top:3px;">
                                                                                        <apex:outputText value="{!h.Name}" style="float: left; margin-left: 2px;color: #3B6080;font-size:11px;font-weight:bold;text-align:center;white-space:nowrap;" />
                                                                                        <span class="trigger" style="cursor:pointer;color:#ee0000;">*</span>
                                                                                        <span class="bubble_html" style="display:none;">{!HTMLENCODE($Label.SortingNotAvailable)}</span>
                                                                                    </apex:outputPanel>
                                                                                </div>
                                                                            </td> 
                                                                        </apex:repeat>
                                                                    </tr>
                                                                </table>
                                                            </div>
                                                        </div>
                                                        
                                       

                                                        <!-- Cells Panel -->
                                                        <div id="cellContainer" class="cellContainer">
                                                            <div id="cells" class="cells">
                                                                <table id="dealsTable" cellspacing="0" border="0">
                                                                    <apex:variable var="iterIndex" value="{!1}"/>
                                                                    <apex:variable var="index" value="{!0}"/>     
                                                                    <apex:repeat var="d" value="{!visibleDeals}" id="valuesGenerator">
                                                                        <tr class="dataRow whiteCells rows{!RIGHT(TEXT(iterIndex),2)} {!IF(ISNULL(d.d.id) && mod(d.i,2)==0,'oddNewDealRow',
                                                                        IF(ISNULL(d.d.id) && mod(d.i,2)!=0,'evenNewDealRow',
                                                                        IF(mod(d.i,2)==0 && d.editable,'odd',
                                                                        IF(mod(d.i,2)==0 && !d.editable,'oddNonEditable',
                                                                        IF(d.editable,'even',
                                                                        'evenNonEditable')))))}" style="cursor:pointer;">
 
                                                                            <apex:repeat value="{!d.attrs}" var="y" id="genDealTable">
                                                                                <td onclick="if('{!JSENCODE(y.field)}'=='SourceID__c' && '{!JSENCODE(d.sourceId)}'){window.open('/{!JSENCODE(d.sourceId)}');return false};if({!OR((LEFT(y.field ,8)== 'ProfileI'),(y.datatype=='usertype'))}){if(!countEditing()){return false;}else{OpenningUser('{!y.UserID}');}}else{doEdit('{!d.d.id}');}" style="{!IF(OR((LEFT(y.field ,8)== 'ProfileI'),(y.datatype=='usertype')),'cursor:pointer;color:#396F90;','')}"  >  
                                                                                    <apex:outputPanel rendered="{!TEXT(iterIndex) == '1'}" style="display:none" styleClass="cWidth">
                                                                                        <apex:outputText value="{!TEXT(FLOOR(y.customWidth))}"/>          
                                                                                    </apex:outputPanel>
                                                                                    
                                                                                    <apex:outputPanel rendered="{!d.editable}"  layout="block" style="width:{!FLOOR(y.customWidth)-4}px;overflow:hidden;white-space:nowrap">
        
                                                                                        <apex:outputPanel layout="block"  rendered="{!LEFT(y.field,7) == 'Boolean'}">
                                                                                            <apex:selectList id="boolDrpdwn" onfocus="adjustScroll();compareObjHandler[this.id] = this.options[this.selectedIndex].value;" onchange="checkValue(this,'{!LOWER(y.datatype)}',{!y.required}, '{!y.field}', '');$('.rowShow{!RIGHT(TEXT(iterIndex),2)}',$(this).parent().parent()).html(this.options[this.selectedIndex].text+'&nbsp;');" styleclass="row{!RIGHT(TEXT(iterIndex),2)}" style="display:none;width:{!FLOOR(y.customWidth)-6}px;" value="{!y.value}" rendered="{!LEFT(y.field,7) == 'Boolean'}" size="1" multiselect="false">
                                                                                                <apex:selectOptions value="{!booleanOptions}" />
                                                                                            </apex:selectList>
                                                                                        </apex:outputPanel>
                                                                                        <apex:outputPanel styleclass="rowShow{!RIGHT(TEXT(iterIndex),2)}" rendered="{!LEFT(y.field,7) == 'Boolean'}" layout="block">
                                                                                            <c:XactlySMBLongTextBubble text="{!y.value}" maxLength="{!ROUND((y.customWidth / 5.7) - 4, 0)}" wrappStyle=""/>
                                                                                        </apex:outputPanel>
        
                                                                                        <apex:outputPanel layout="none" rendered="{!y.field == 'ProfileId__c'}" >
                                                                                            <apex:selectList id="usrsDrpdwn" onfocus="adjustScroll();compareObjHandler[this.id] = this.options[this.selectedIndex].value;" onchange="checkValue(this,'{!LOWER(y.datatype)}',{!y.required}, '{!y.field}', '');$('.rowShow{!RIGHT(TEXT(iterIndex),2)}',$(this).parent()).html(this.options[this.selectedIndex].text+'&nbsp;');changeUser(this);" value="{!d.d.XactlyExpress__ProfileID__c}" size="1" multiselect="false" rendered="{!y.field == 'ProfileId__c'}" style="display:none;width:{!FLOOR(y.customWidth)-6}px;" styleclass="row{!RIGHT(TEXT(iterIndex),2)} select_salesperson_row">
                                                                                                <apex:selectOptions value="{!usersOptions}" />
                                                                                            </apex:selectList>
                                                                                            <input type="text" style="display:none;" class="last_user_edit_currency" value="{!d.d.ProfileId__c}"/>
                                                                                        </apex:outputPanel>
                                                                                        <apex:outputPanel styleclass="rowShow{!RIGHT(TEXT(iterIndex),2)}" rendered="{!y.field == 'ProfileId__c'}" layout="block">
                                                                                            <c:XactlySMBLongTextBubble text="{!d.Salesperson}" maxLength="{!ROUND((y.customWidth / 5.7) - 4, 0)}" wrappStyle=""/>
                                                                                        </apex:outputPanel>
                                                                                        <!-- UsserType -->
                                                                                 
                                                                                           <apex:outputPanel layout="none" rendered="{!y.field == 'ProfileID2__c'}" >
                                                                                            <apex:selectList id="usrsDrpdwnUserType2" onfocus="adjustScroll();compareObjHandler[this.id] = this.options[this.selectedIndex].value;" onchange="checkValue(this,'{!LOWER(y.datatype)}',{!y.required}, '{!y.field}', '');$('.rowShow{!RIGHT(TEXT(iterIndex),2)}',$(this).parent()).html(this.options[this.selectedIndex].text+'&nbsp;');changeOpUser(this)" value="{!d.d.XactlyExpress__ProfileID2__c}" size="1" multiselect="false" rendered="{!y.field == 'ProfileID2__c'}" style="display:none;width:{!FLOOR(y.customWidth)-6}px;" styleclass="row{!RIGHT(TEXT(iterIndex),2)}">
                                                                                                <apex:selectOptions value="{!usersOptions}" />
                                                                                            </apex:selectList>
                                                                                        </apex:outputPanel>
                                                                                          <apex:outputPanel styleclass="rowShow{!RIGHT(TEXT(iterIndex),2)}" rendered="{!y.field == 'ProfileID2__c'}" layout="block">
                                                                                            <c:XactlySMBLongTextBubble text="{!d.UserType2}" maxLength="{!ROUND((y.customWidth / 5.7) - 4, 0)}" wrappStyle=""/>
                                                                                        </apex:outputPanel>
                                                                                        
                                                                                        <apex:outputPanel layout="none" rendered="{!y.field == 'ProfileID3__c'}" >
                                                                                            <apex:selectList id="usrsDrpdwnUserType3" onfocus="adjustScroll();compareObjHandler[this.id] = this.options[this.selectedIndex].value;" onchange="checkValue(this,'{!LOWER(y.datatype)}',{!y.required}, '{!y.field}', '');$('.rowShow{!RIGHT(TEXT(iterIndex),2)}',$(this).parent()).html(this.options[this.selectedIndex].text+'&nbsp;');changeOpUser(this)" value="{!d.d.XactlyExpress__ProfileID3__c}" size="1" multiselect="false" rendered="{!y.field == 'ProfileID3__c'}" style="display:none;width:{!FLOOR(y.customWidth)-6}px;" styleclass="row{!RIGHT(TEXT(iterIndex),2)}">
                                                                                                <apex:selectOptions value="{!usersOptions}" />
                                                                                            </apex:selectList>
                                                                                        </apex:outputPanel>
                                                                                          <apex:outputPanel styleclass="rowShow{!RIGHT(TEXT(iterIndex),2)}" rendered="{!y.field == 'ProfileID3__c'}" layout="block">
                                                                                            <c:XactlySMBLongTextBubble text="{!d.UserType3}" maxLength="{!ROUND((y.customWidth / 5.7) - 4, 0)}" wrappStyle=""/>
                                                                                        </apex:outputPanel>
                                                                                        <apex:outputPanel layout="none" rendered="{!y.field == 'ProfileID4__c'}" >
                                                                                            <apex:selectList id="usrsDrpdwnUserType4" onfocus="adjustScroll();compareObjHandler[this.id] = this.options[this.selectedIndex].value;" onchange="checkValue(this,'{!LOWER(y.datatype)}',{!y.required}, '{!y.field}', '');$('.rowShow{!RIGHT(TEXT(iterIndex),2)}',$(this).parent()).html(this.options[this.selectedIndex].text+'&nbsp;');changeOpUser(this)" value="{!d.d.XactlyExpress__ProfileID4__c}" size="1" multiselect="false" rendered="{!y.field == 'ProfileID4__c'}" style="display:none;width:{!FLOOR(y.customWidth)-6}px;" styleclass="row{!RIGHT(TEXT(iterIndex),2)}">
                                                                                                <apex:selectOptions value="{!usersOptions}" />
                                                                                            </apex:selectList>
                                                                                        </apex:outputPanel>
                                                                                          <apex:outputPanel styleclass="rowShow{!RIGHT(TEXT(iterIndex),2)}" rendered="{!y.field == 'ProfileID4__c'}" layout="block">
                                                                                            <c:XactlySMBLongTextBubble text="{!d.UserType4}" maxLength="{!ROUND((y.customWidth / 5.7) - 4, 0)}" wrappStyle=""/>
                                                                                        </apex:outputPanel>
                                                                                        
                                                                                          <apex:outputPanel layout="none" rendered="{!y.field == 'ProfileID5__c'}" >
                                                                                            <apex:selectList id="usrsDrpdwnUserType5" onfocus="adjustScroll();compareObjHandler[this.id] = this.options[this.selectedIndex].value;" onchange="checkValue(this,'{!LOWER(y.datatype)}',{!y.required}, '{!y.field}', '');$('.rowShow{!RIGHT(TEXT(iterIndex),2)}',$(this).parent()).html(this.options[this.selectedIndex].text+'&nbsp;');changeOpUser(this)" value="{!d.d.XactlyExpress__ProfileID5__c}" size="1" multiselect="false" rendered="{!y.field == 'ProfileID5__c'}" style="display:none;width:{!FLOOR(y.customWidth)-6}px;" styleclass="row{!RIGHT(TEXT(iterIndex),2)}">
                                                                                                <apex:selectOptions value="{!usersOptions}" />
                                                                                            </apex:selectList>
                                                                                        </apex:outputPanel>
                                                                                        <apex:outputPanel styleclass="rowShow{!RIGHT(TEXT(iterIndex),2)}" rendered="{!y.field == 'ProfileID5__c'}" layout="block">
                                                                                            <c:XactlySMBLongTextBubble text="{!d.UserType5}" maxLength="{!ROUND((y.customWidth / 5.7) - 4, 0)}" wrappStyle=""/>
                                                                                        </apex:outputPanel>
                                                                                        
                                                                                        <apex:outputPanel styleclass="rowShow{!RIGHT(TEXT(iterIndex),2)} nonEditable" rendered="{!y.field=='CreatedById'}" layout="block">
                                                                                            <c:XactlySMBLongTextBubble text="{!d.userTypeCreatedBy}" maxLength="{!ROUND((y.customWidth / 5.7) - 4, 0)}" wrappStyle=""/>
                                                                                        </apex:outputPanel>
                                                                                        
                                                                                         <apex:outputPanel styleclass="rowShow{!RIGHT(TEXT(iterIndex),2)} nonEditable" rendered="{!y.field=='LastModifiedById'}" layout="block">
                                                                                            <c:XactlySMBLongTextBubble text="{!d.userTypeLastModifiedBy}" maxLength="{!ROUND((y.customWidth / 5.7) - 4, 0)}" wrappStyle=""/>
                                                                                        </apex:outputPanel>
                                                               
                                                                                           <!-- UsserTypeEnd -->
                                                                                           
                                                                                           <!-- import Source -->
                                                                                           <apex:outputPanel styleclass="rowShow{!RIGHT(TEXT(iterIndex),2)} nonEditable" rendered="{!y.field=='importSource'}" layout="block">
                                                                                       			<c:XactlySMBLongTextBubble text="{!d.importSource}" maxLength="{!ROUND((y.customWidth / 5.7) - 4, 0)}" wrappStyle=""/>
                                                                                    	    </apex:outputPanel>	
                                                                                            <!-- end import source -->
                                                                                        <apex:outputPanel styleclass="row{!RIGHT(TEXT(iterIndex),2)}" style="display:none;" layout="block" rendered="{!y.field == 'ProductId__c'}">
                                                                                            <div id="{!IF(y.field == 'ProductId__c', TEXT(d.idx) + '-product', '')}">
                                                                                                <input disabled="disabled" onfocus="adjustScroll();" type="text" class="{!d.idx}-productName" value="{!d.ProductName}" style="width:{!FLOOR(y.customWidth)-25}px;" onchange="checkValue(this,'{!LOWER(y.datatype)}',{!y.required}, '{!y.field}', '');$('.rowShow{!RIGHT(TEXT(iterIndex),2)}',$(this).parent().parent().parent()).html('{!TRIM('<a')} href=\'../'+$('.{!d.idx}-productId',$(this).parent()).val()+'\'{!TRIM('>')}'+this.value+'{!TRIM('</a>')}&nbsp;');"/>
                                                                                                 <div class="inteactionIconSprite magnifier" style="margin-left: 79px;margin-top: -15px;" onclick="openProductPopup({!d.idx});compareObjHandler[$('.{!TEXT(d.idx)}-productId',$(this).parent())[0].id] = $('.{!TEXT(d.idx)}-productId',this.parentNode)[0].value;"></div>    
                                                                                                <apex:inputText id="prdId" style="display:none;" styleClass="{!d.idx}-productId" value="{!d.d.XactlyExpress__ProductID__c}"/>
                                                                                            </div> 
                                                                                        </apex:outputPanel>
                                                                                        <apex:outputPanel styleclass="rowShow{!RIGHT(TEXT(iterIndex),2)}" rendered="{!y.field == 'ProductId__c'}" layout="block" style="white-space:nowrap;">
                                                                                            <a href="../{!d.d.XactlyExpress__ProductID__c}">
                                                                                            <c:XactlySMBLongTextBubble text="{!d.ProductName}" maxLength="{!ROUND((y.customWidth / 5.7) - 4, 0)}" wrappStyle=""/>
                                                                                            </a>
                                                                                        </apex:outputPanel>
                                                                                        
                                                                                         <!-- Account Id -->
                                                                                        <apex:outputPanel styleclass="row{!RIGHT(TEXT(iterIndex),2)}" style="display:none;" layout="block" rendered="{!y.field == 'AccountId__c'}">
                                                                                            <div id="{!IF(y.field == 'AccountId__c', TEXT(d.idx) + '-account', '')}">
                                                                                                <input disabled="disabled" onfocus="adjustScroll();" type="text" class="{!d.idx}-accountName" value="{!d.AccountName}" style="width:{!FLOOR(y.customWidth)-25}px;float:left;"  onchange="checkValue(this,'{!LOWER(y.datatype)}',{!y.required}, '{!y.field}', '');$('.rowShow{!RIGHT(TEXT(iterIndex),2)}',$(this).parent().parent().parent()).html('{!TRIM('<a')} href=\'../'+$('.{!d.idx}-accountId',$(this).parent()).val()+'\'{!TRIM('>')}'+this.value+'{!TRIM('</a>')}&nbsp;');"/>
                                                                                                <apex:commandLink id="openAccountPopup" styleclass="openAccountPopup{!d.idx}" onclick="openAccountPopup({!d.idx});compareObjHandler[$('.{!d.idx}-accountId',$(this).parent())[0].id] = $('.{!d.idx}-accountId',this.parentNode)[0].value;" rerender="errorMsg"></apex:commandLink>
                                                                                                <div class="inteactionIconSprite magnifier" style="float:left; 79px;" onclick="jQuery('.openAccountPopup{!d.idx}').click()"></div>
                                                                                                <apex:inputText id="accId" style="display:none;" styleClass="{!d.idx}-accountId" value="{!d.d.XactlyExpress__AccountID__c}"/>
                                                                                            </div>   
                                                                                        </apex:outputPanel>
                                                                                        
                                                                                       
                                                                                        <apex:outputPanel styleclass="rowShow{!RIGHT(TEXT(iterIndex),2)}" rendered="{!y.field == 'AccountId__c'}" layout="block" style="white-space:nowrap;">
                                                                                            <a href="../{!d.d.XactlyExpress__AccountID__c}">
                                                                                            <c:XactlySMBLongTextBubble text="{!d.AccountName}" maxLength="{!ROUND((y.customWidth / 5.7) - 4, 0)}" wrappStyle=""/>
                                                                                            </a>
                                                                                        </apex:outputPanel>
                                                                                        
                                                                                        <!-- DealId -->
                                                                                        <apex:outputPanel styleclass="row{!RIGHT(TEXT(iterIndex),2)}" style="display:none;" layout="block" rendered="{!y.field == 'DealId__c'}">
                                                                                            <apex:inputField id="dealIdInp" style="width:{!FLOOR(y.customWidth)-6}px;" onblur="checkValue(this,'{!LOWER(y.datatype)}',{!y.required}, '{!y.field}', '');$('.rowShow{!RIGHT(TEXT(iterIndex),2)}',$(this).parent().parent()).html(this.value+'&nbsp;');" onfocus="adjustScroll();compareObjHandler[this.id] = this.value;" value="{!d.d.XactlyExpress__DealID__c}"/>
                                                                                        </apex:outputPanel>
                                                                                        <apex:outputPanel styleclass="rowShow{!RIGHT(TEXT(iterIndex),2)}" rendered="{!y.field == 'DealId__c'}" layout="block">
                                                                                            <c:XactlySMBLongTextBubble text="{!d.d.XactlyExpress__DealID__c}" maxLength="{!ROUND((y.customWidth / 5.7) - 4, 0)}" wrappStyle=""/>
                                                                                        </apex:outputPanel>
                                                                                        
                                                                                        <!--  Deal Date -->
                                                                                        <apex:outputPanel styleclass="dateType row{!RIGHT(TEXT(iterIndex),2)}" style="display:none;height: 25px;text-align: center;margin-top:6px" layout="block" rendered="{!y.field == 'DealDate__c'}">
                                                                                            <apex:inputField style="width:{!FLOOR(y.customWidth)-6}px;" id="newdealdate" onblur="checkValue(this,'{!LOWER(y.datatype)}',{!y.required}, '{!y.field}', dealdate{!FLOOR(index)}_{!RIGHT(TEXT(iterIndex),2)})" value="{!d.d.XactlyExpress__DealDate__c}"/>
                                                                                                <input type="hidden" value="{!FLOOR(index)}_{!RIGHT(TEXT(iterIndex),2)}" class="indexOfDealDateMatrix"/>
                                                                                                <input type="hidden" value="{!$Component.newdealdate}" id="newdealdate{!FLOOR(index)}_{!RIGHT(TEXT(iterIndex),2)}"/>
                                                                                        </apex:outputPanel>
                                                                                        <apex:outputPanel styleclass="rowShow{!RIGHT(TEXT(iterIndex),2)}" style="text-align: center;" rendered="{!y.field == 'DealDate__c'}" layout="block">
                                                                                            <apex:outputText id="dealdate" value="{!d.dateFormat}"/>
                                                                                            <input type="hidden" value="{!$Component.dealdate}" id="dealdate{!FLOOR(index)}_{!RIGHT(TEXT(iterIndex),2)}"/>
                                                                                        </apex:outputPanel>
                                                                                        <!-- Date different of DealDate -->  
                                                                                        <apex:outputPanel styleclass="row{!RIGHT(TEXT(iterIndex),2)}" style="display:none;text-align: center;" layout="block" rendered="{!AND(y.field != 'DealDate__c', y.datatype=='date',y.field!='CreatedDate',y.field!='LastModifiedDate')}">
                                                                                            <apex:inputText style="width:{!FLOOR(y.customWidth)-6}px;" onfocus="showCalendar('{!$Component.fld}');adjustScroll();compareObjHandler[this.id] = this.value;" onchange="checkValue(this,'{!LOWER(y.datatype)}',{!y.required}, '{!y.field}', '');$('.rowShow{!RIGHT(TEXT(iterIndex),2)}',$(this).parent().parent()).html(this.value+'&nbsp;');" id="fld" value="{!y.value}"/>
                                                                                        </apex:outputPanel>   
        
                                                                                        <apex:outputPanel styleclass="rowShow{!RIGHT(TEXT(iterIndex),2)}" style="text-align: center;"  rendered="{!AND(y.field != 'DealDate__c', y.datatype=='date',y.field!='CreatedDate',y.field!='LastModifiedDate')}" layout="block">
                                                                                            <c:XactlySMBLongTextBubble text="{!y.value}" maxLength="{!ROUND((y.customWidth / 5.7) - 4, 0)}" wrappStyle=""/>
                                                                                        </apex:outputPanel>  
                                                                                        
                                                                                        <!-- nonEditable dates -->
                                                                                        <apex:outputPanel styleclass="rowShow{!RIGHT(TEXT(iterIndex),2)} nonEditable" style="text-align: center;"  rendered="{!OR(y.field=='CreatedDate',y.field=='LastModifiedDate')}" layout="block">
                                                                                            <c:XactlySMBLongTextBubble text="{!y.value}" maxLength="{!ROUND((y.customWidth / 5.7) - 4, 0)}" wrappStyle=""/>
                                                                                        </apex:outputPanel>  
                                                                                        
                                                                                        <!-- object Id  -->
                                                                                        <apex:outputPanel styleclass="rowShow{!RIGHT(TEXT(iterIndex),2)} nonEditable"  rendered="{!y.field='SourceID__c'}" layout="block">
                                                                                            <apex:outputPanel rendered="{!d.sourceId!=null}">
                                                                                            	<a href="javascript: void(0);">
                                                                                        	   	  <c:XactlySMBLongTextBubble text="{!d.sourceId}" maxLength="{!ROUND((y.customWidth / 5.7) - 4, 0)}" wrappStyle=""/>
                                                                                        		</a>
                                                                                        	</apex:outputPanel>
                                                                                        </apex:outputPanel>
                                                                                        
                                                                                        <apex:outputPanel styleclass="row{!RIGHT(TEXT(iterIndex),2)}" style="display:none" layout="block" rendered="{!AND(y.field != 'CurrencyIsoCode', y.field != 'ProductId__c', y.field != 'AccountId__c', y.field != 'Relationship__c', y.field != 'DealId__c', y.field != 'ProfileId__c', y.field != 'ProfileID2__c', y.field != 'ProfileID3__c', y.field != 'ProfileID4__c', y.field != 'ProfileID5__c',  y.field != 'DealDate__c', y.field != 'ProfileId__r.UserId__c',y.datatype!='date', LEFT(y.field,7) != 'Boolean', y.field!='importSource',y.field!='CreatedDate',y.field!='LastModifiedDate',y.field!='CreatedById',y.field!='LastModifiedById',y.field!='SourceID__c')}">
                                                                                            <apex:inputText style="width:{!IF(y.datatype == 'currency',FLOOR(y.customWidth)-26,FLOOR(y.customWidth)-6)}px;" id="inpGrl" onblur="checkValue(this,'{!LOWER(y.datatype)}',{!y.required}, '{!y.field}', '');$('.rowShow{!RIGHT(TEXT(iterIndex),2)}',$(this).parent().parent()).html(this.value+'&nbsp;');if('{!y.datatype}' == 'currency' || '{!y.datatype}' == 'decimal'){this.value.indexOf('-')!=-1?$('.rowShow{!RIGHT(TEXT(iterIndex),2)}',$(this).parent().parent()).removeClass('editablePositive').addClass('editableNegative'):$('.rowShow{!RIGHT(TEXT(iterIndex),2)}',$(this).parent().parent()).removeClass('editableNegative').addClass('editablePositive');}{!IF(y.datatype == 'currency','saveCacheValue(this);','')}" onfocus="adjustScroll();compareObjHandler[this.id] = this.value;" value="{!y.value}" styleclass=" {!IF(y.datatype == 'currency','isCurrency','')} {!IF(OR(y.datatype == 'currency', y.datatype == 'decimal'),IF(NOT(CONTAINS(y.value,'-')),'editablePositive','editableNegative'),'')}"/>
                                                                                            <apex:outputpanel layout="none" rendered="{!y.datatype == 'currency'}">
                                                                                                <input type="text" style="display:none;" class="cache_currency" value="{!y.value}"/>
                                                                                            </apex:outputpanel>
                                                                                            <span class="conversionChange"></span>
                                                                                        </apex:outputPanel>
                                                                                        <apex:outputPanel styleclass="row{!RIGHT(TEXT(iterIndex),2)}" style="display:none" layout="block" rendered="{!y.field == 'CurrencyIsoCode'}">
                                                                                            <input disabled="disabled"  id="currencySelect" class="diplayCurrency" size="20"/>
                                                                                            <input type="hidden" value="rows{!RIGHT(TEXT(iterIndex),2)}##{!y.value}" class="previousCurrencyArrayMatrix"/>
                                                                                        </apex:outputPanel>
                                                                                        
                                                                                        <apex:outputPanel styleclass="rowShow{!RIGHT(TEXT(iterIndex),2)} {!IF(y.datatype == 'currency','isCurrency','')} {!IF(OR(y.datatype == 'currency', y.datatype == 'decimal'),IF(NOT(CONTAINS(y.value,'-')),'editablePositive','editableNegative'),'')}" rendered="{!AND(y.field != 'ProductId__c', y.field != 'AccountId__c', y.field != 'Relationship__c', y.field != 'DealId__c', y.field != 'ProfileId__c', y.field != 'ProfileID2__c', y.field != 'ProfileID3__c', y.field != 'ProfileID4__c', y.field != 'ProfileID5__c',   y.field != 'DealDate__c', y.field != 'ProfileId__r.UserId__c',y.datatype!='date', LEFT(y.field,7) != 'Boolean',y.field!='importSource',y.field!='CreatedDate',y.field!='LastModifiedDate',y.field!='CreatedById',y.field!='LastModifiedById',y.field!='SourceID__c')}" layout="block">
                                                                                            <c:XactlySMBLongTextBubble text="{!y.value}" maxLength="{!ROUND((y.customWidth / 5.7) - 4, 0)}" wrappStyle=""/>
                                                                                        </apex:outputPanel>  
                                                                                        
                                                                                       
                                                                                                                
                                                                                </apex:outputPanel>
                                                                                
                                                                                <!-- Deals in close Period -->
                                                                                <apex:outputPanel rendered="{!!d.editable}" style="width:{!FLOOR(y.customWidth)-4}px;overflow:hidden;white-space:nowrap;{!IF(OR(y.field == 'DealDate__c',y.datatype == 'date'),'text-align:center;','')}" layout="block">
                                                                                    <apex:outputPanel rendered="{!LEFT(y.field,7) == 'Boolean'}" onclick="displayNotEditableError();">
                                                                                        <c:XactlySMBLongTextBubble text="{!y.value}" maxLength="{!ROUND((y.customWidth / 5.7) - 4, 0)}" wrappStyle="white-space:nowrap;"/>
                                                                                    </apex:outputPanel>
                                                                                    <apex:outputPanel rendered="{!y.field == 'DealId__c'}" onclick="displayNotEditableError();">
                                                                                        <c:XactlySMBLongTextBubble text="{!d.d.XactlyExpress__DealID__c}" maxLength="{!ROUND((y.customWidth / 5.7) - 4, 0)}" wrappStyle="white-space:nowrap;"/>
                                                                                    </apex:outputPanel>
                                                                                    <apex:outputPanel layout="block" rendered="{!!ISNULL(d.d.ProfileId__r.XactlyExpress__UserID__c) && y.field == 'ProfileId__c'}" onclick="displayNotEditableError();">
                                                                                        <c:XactlySMBLongTextBubble text="{!d.d.ProfileId__r.UserId__r.Name}" maxLength="{!ROUND((y.customWidth / 5.7) - 4, 0)}" wrappStyle="white-space:nowrap;"/>
                                                                                    </apex:outputPanel>
                                                                                
                                                                                    <apex:outputPanel rendered="{!y.field == 'ProductId__c'}" onclick="displayNotEditableError();">
                                                                                        <a href="/(!.d.d.ProductId__r.Id)" target="_blank"><c:XactlySMBLongTextBubble text="{!d.d.ProductId__r.Name}" maxLength="{!ROUND((y.customWidth / 5.7) - 4, 0)}" wrappStyle="white-space:nowrap;"/></a>
                                                                                    </apex:outputPanel>
                                                                                    <apex:outputPanel rendered="{!y.field == 'AccountId__c'}" onclick="displayNotEditableError();">
                                                                                        <a href="/(!.d.d.AccountId__r.Id)" target="_blank"><c:XactlySMBLongTextBubble text="{!d.d.AccountId__r.Name}" maxLength="{!ROUND((y.customWidth / 5.7) - 4, 0)}" wrappStyle="white-space:nowrap;"/></a>
                                                                                    </apex:outputPanel>
                                                                                    <apex:outputPanel rendered="{!AND(y.field != 'ProductId__c',y.field != 'ProfileID2__c', y.field != 'ProfileID3__c', y.field != 'ProfileID4__c', y.field != 'ProfileID5__c',   y.field != 'AccountId__c', y.field != 'DealId__c', y.field != 'ProfileId__c', y.field != 'ProfileId__r.UserId__c', LEFT(y.field,7) != 'Boolean', y.field!='importSource', y.field!='CreatedById',y.field!='LastModifiedById',y.field!='SourceID__c')}" styleclass="{!IF(y.datatype == 'currency','isCurrency','')}" style="{!IF(OR(y.datatype == 'currency', y.datatype == 'decimal'),'float:right;','')}">
                                                                                        <c:XactlySMBLongTextBubble text="{!y.value}" maxLength="{!ROUND((y.customWidth / 5.7) - 4, 0)}" wrappStyle="white-space:nowrap;"/>
                                                                                    </apex:outputPanel>
                                                                           
                                                                                    <apex:outputPanel rendered="{!y.field == 'ProfileID2__c'}" layout="block">
                                                                                        <c:XactlySMBLongTextBubble text="{!d.UserType2}" maxLength="{!ROUND((y.customWidth / 5.7) - 4, 0)}" wrappStyle="white-space:nowrap;"/>
                                                                                    </apex:outputPanel>
                                                                                    
                                                                                    <apex:outputPanel rendered="{!y.field == 'ProfileID3__c'}" layout="block">
                                                                                        <c:XactlySMBLongTextBubble text="{!d.UserType3}" maxLength="{!ROUND((y.customWidth / 5.7) - 4, 0)}" wrappStyle="white-space:nowrap;"/>
                                                                                    </apex:outputPanel>
                                                                                    
                                                                                    <apex:outputPanel rendered="{!y.field == 'ProfileID4__c'}" layout="block">
                                                                                        <c:XactlySMBLongTextBubble text="{!d.UserType4}" maxLength="{!ROUND((y.customWidth / 5.7) - 4, 0)}" wrappStyle="white-space:nowrap;"/>
                                                                                    </apex:outputPanel>
                                                                                    
                                                                                    <apex:outputPanel rendered="{!y.field == 'ProfileID5__c'}" layout="block">
                                                                                        <c:XactlySMBLongTextBubble text="{!d.UserType5}" maxLength="{!ROUND((y.customWidth / 5.7) - 4, 0)}" wrappStyle="white-space:nowrap;"/>
                                                                                    </apex:outputPanel>    
                                                                                    
                                                                                    <apex:outputPanel rendered="{!y.field == 'CreatedById'}" layout="block">
                                                                               			<c:XactlySMBLongTextBubble text="{!d.userTypeCreatedBy}" maxLength="{!ROUND((y.customWidth / 5.7) - 4, 0)}" wrappStyle="white-space:nowrap;"/>
                                                                               	    </apex:outputPanel>	 
                                                                               	    
                                                                               	     <apex:outputPanel rendered="{!y.field == 'LastModifiedById'}" layout="block">
                                                                               			<c:XactlySMBLongTextBubble text="{!d.userTypeLastModifiedBy}" maxLength="{!ROUND((y.customWidth / 5.7) - 4, 0)}" wrappStyle="white-space:nowrap;"/>
                                                                               	    </apex:outputPanel>	
                                                                                    
                                                                                    <apex:outputPanel rendered="{!y.field=='importSource'}" layout="block">
                                                                               			<c:XactlySMBLongTextBubble text="{!d.importSource}" maxLength="{!ROUND((y.customWidth / 5.7) - 4, 0)}" wrappStyle="white-space:nowrap;"/>
                                                                               	    </apex:outputPanel>	 
                                                                               	    
                                                                               	    <apex:outputPanel styleclass="rowShow{!RIGHT(TEXT(iterIndex),2)} nonEditable"  rendered="{!y.field='SourceID__c'}" layout="block">
                                                                                            <apex:outputPanel rendered="{!d.sourceId!=null}">
                                                                                            	<a href="javascript: void(0);">
                                                                                        	   	  <c:XactlySMBLongTextBubble text="{!d.sourceId}" maxLength="{!ROUND((y.customWidth / 5.7) - 4, 0)}" wrappStyle=""/>
                                                                                        		</a>
                                                                                        	</apex:outputPanel>
                                                                                     </apex:outputPanel>
                                                                                </apex:outputPanel>                                                                    
                                                                            </td>
                                                                            <apex:variable var="index" value="{!index + 1}"/>   
                                                                        </apex:repeat>                                      
                                                                    </tr>
                                                                    <apex:variable var="iterIndex" value="{!iterIndex + 1}"/>
                                                                </apex:repeat>
                                                            </table>
                                                        </div>
                                                        
                                                        
                                                        
                                                        
                                                        
                                                    </div>
                                                </div>
                                            </apex:outputPanel>
                                        </div>
                                    </div>      
                                </apex:outputPanel>
                            </apex:outputPanel>        
                        </div>
                        
                        <apex:inputHidden id="currentPage" value="{!currentPage}"/>
                        <div class="tFooter">
                            <div class="footerLeftSide">
                                <c:XactlySMBMessageBox msg="{!msgLimitAlert}" />
                                <c:XactlySMBMessageBox msg="{!msgLimitSearchAlert}" />
                            </div>
                            <apex:outputPanel id="prevnextarrows" styleClass="prevNextWrapp">                            
                                
                                    <apex:outputPanel layout="none" rendered="{!currentPage > 1}"> 
                                           <div id="btnFirstButton" onclick="if(!checkEditing()){return false;};$('#'+currentPage).val(1);waitOn();goToPage()">
                                            <div class="inteactionIconSprite btnFirstPagebk"></div>
                                            </div>
                                            <div id="btnPrevPageButton" onclick="if(!checkEditing()){return false;};$('#'+currentPage).val($('#'+currentPage).val()==1?1:parseInt($('#'+currentPage).val())-1);waitOn();goToPage()">
                                                <div class="inteactionIconSprite btnPrevPagebk"></div>
                                            </div>
                                            &nbsp;<apex:outputText value="{!$Label.xactlyexpress__Previous}" style="color:#404040;"/>&nbsp;
                                    </apex:outputPanel>
                                    <apex:outputPanel layout="none" rendered="{!currentPage == 1}">
                                        <div class="inteactionIconSprite btnFirstPage"></div>
                                        <div class="inteactionIconSprite btnPrevPage"></div>&nbsp;<apex:outputText value="{!$Label.xactlyexpress__Previous}" style="color:#A8A8A8;"/>&nbsp;
                                    </apex:outputPanel>
                                    <apex:outputPanel layout="none" rendered="{!currentPage < numPages}">
                                      <apex:outputText value="{!$Label.xactlyexpress__Next}" style="color:#404040;"/>&nbsp;
                                                 <div id="btnLastPageButton" onclick="if(!checkEditing()){return false;};$('#'+currentPage).val({!numPages});waitOn();goToPage()">
                                                   <div class="inteactionIconSprite btnLastPagebk"></div>
                                               </div>
                                                <div id="btnNextPageButton"onclick="if(!checkEditing()){return false;};$('#'+currentPage).val($('#'+currentPage).val()=={!numPages}?{!numPages}:parseInt($('#'+currentPage).val())+1);waitOn();goToPage()">
                                                    <div class="inteactionIconSprite btnNextPagebk" ></div>
                                                </div>
                                    </apex:outputPanel>
                                    <apex:outputPanel layout="none" rendered="{!currentPage == numPages}">
                                        <apex:outputText value="{!$Label.xactlyexpress__Next}" style="color:#A8A8A8;"/>&nbsp;
                                        <div class="inteactionIconSprite btnLastPage  {!IF(visibleDeals.size==0,'btnLastPageEmptyTable','')}" ></div>
                                        <div class="inteactionIconSprite btnNextPage {!IF(visibleDeals.size==0,'btnNextPageEmptyTable','')}" ></div>
                                    </apex:outputPanel>
                                    
                                                            
                            </apex:outputPanel>
                            <apex:outputPanel styleclass="footerRightSide" id="paginator">                            
                                <apex:outputText value="{!$Label.xactlyexpress__Page}"/>&nbsp;<input type="Text" value="{!currentPage}" onfocus="checkEditing();" onblur="MoveIfNeeded(this.value);" style="width:16px;"/>&nbsp;<apex:outputText value="{!$Label.xactlyexpress__Of}"/>&nbsp;<apex:outputText value="{!numPages}"/>
                            </apex:outputPanel>
                        </div>
                    </apex:outputPanel>      
                                  
                                    <apex:outputPanel layout="block" id="commentBox" style="display:none;">
                                        <apex:inputHidden id="public_comment" value="{!oldPublicComment}" />
                                        <apex:inputHidden id="private_comment" value="{!oldPrivateComment}" />
                                        
                                    </apex:outputPanel>

                </div><!-- END CONTENT -->
                <div style="clear:both;"></div>
            </apex:outputPanel><!-- END CONTENTWRAPPER -->
            </div>
            
            <!-- FOOTER  -->
            <c:XactlySMBFooter isReadOnlyAdmin="{!isReadOnlyAdmin}" packageVersion="{!packageVersion}" showPrevious="true" showNext="true" showSave="true" showRefresh="true" showExport="false"/>

            <apex:outputPanel rendered="{!!isAdmin}">
                <c:XactlySMBErrorMsg error="{!$Label.xactlyexpress__InsufficientPermissions}" />
            </apex:outputPanel>
            
            <apex:repeat id="uCurrencyR" var="uCurrency" value="{!userCurrencys}">
                <input class="hidden" id="{!uCurrency.value}_currencyKey" value="{!uCurrency.label}"/>
	        </apex:repeat>
	        <apex:repeat id="cValuesR" var="cValues" value="{!currencysValues}">
                <input class="hidden" id="{!cValues.value}_currencyValue" value="{!cValues.label}"/>
	        </apex:repeat>
	        <input class="hidden" id="xactlySMBCalculateStep2" value="{!JSENCODE($Page.XactlySMBCalculateStep2)}"/>
	        <input class="hidden" id="xactlySMBCalculateStep3" value="{!JSENCODE($Page.XactlySMBCalculateStep3)}"/>
	        <input class="hidden" id="labelConversionInformation" value="{!$Label.ConversionInformation}"/>
	        <input class="hidden" id="labelDealValue" value="{!$Label.Dealvalue}"/>
	        <input class="hidden" id="labelConversion" value="{!$Label.Conversion}"/>
            <input class="hidden" id="labelResultingValue" value="{!$Label.ResultingValue}"/>
            <input class="hidden" id="bubbleImagesPath" value="{!URLFOR($Resource.XactlySMBResources ,'modbubble/images')}"/>
            <input class="hidden" id="labelDeleteCreditQuest" value="{!$Label.deleteCreditQuest}"/>
            <input class="hidden" id="currentSettingsDeals" value="{!currentSettings.deals}"/>
            <input class="hidden" id="labelFinished" value="{!$Label.Finished}"/>
            <input class="hidden" id="labelFailed" value="{!$Label.Failed}"/>
            <input class="hidden" id="labelClickHere" value="{!$Label.clickhere}"/>
            <input class="hidden" id="labelTo" value="{!$Label.to}"/>
            <input class="hidden" id="labelUndoCalculation" value="{!$Label.undocalculation}"/>
            <input class="hidden" id="labelWaiting" value="{!$Label.Waiting}"/>
            <input class="hidden" id="processStatusFailed" value="{!PROCESS_STATUS_FAILED}"/>
            <input class="hidden" id="labelCannotUndoCalculation" value="{!$Label.CannotUndoCalculation}'"/>
            <input class="hidden" id="processStatusFinished" value="{!PROCESS_STATUS_FINISHED}"/>
            <input class="hidden" id="labelUndoCalculationCompleted" value="{!$Label.undoCalculationCompleted}"/>
            <input class="hidden" id="confirmDeleteDealsCurrentView" value="{!$Label.ConfirmDeleteDealsCurrentView}"/>
            <input class="hidden" id="currentSettingsDealsPluralCap" value="{!currentSettings.dealsPluralCap}"/>
            <input class="hidden" id="labelChangesWillNotBeSaved" value="{!JSENCODE($Label.ChangesWillNotBeSaved)}"/>
            <input class="hidden" id="dateFirst" value="{!dateFirst}"/>
            <input class="hidden" id="dateSeparator" value="{!dateSeparator}"/>
            <input class="hidden" id="labelWrongDateFormatJS" value="{!$Label.WrongDateFormatJS}"/>
            <input class="hidden" id="labelEditingADeal" value="{!JSENCODE(EditingADealLabel)}"/>
            <input class="hidden" id="numPages" value="{!numPages}"/>
            <input class="hidden" id="labelWrongCurrencyFormatJS" value="{!$Label.WrongCurrencyFormatJS}"/>
            <input class="hidden" id="labelWrongNumberFormatJS" value="{!$Label.WrongNumberFormatJS}"/>
            <input class="hidden" id="labelChangeKeyInformation" value="{!ChangeKeyInformationLabel}"/>
            <input class="hidden" id="ConfirmMsgDelSelect" value="{!$Label.ConfirmMsgDelSelect}"/>
            <apex:actionFunction name="saveFN" action="{!save}" />
            <apex:actionFunction name="nextSaveFN" action="{!saveNext}" />
            
            <apex:actionFunction name="runClearResult" action="{!runClearResult}" rerender="errorMsg,clearResultStatus" oncomplete="checkUndoCalculation();bindSelectiveDealsEvents();" />
            <apex:actionFunction name="checkClearResult" action="{!checkClearResult}" rerender="errorMsg,clearResultStatus" oncomplete="checkUndoCalculation();bindSelectiveDealsEvents();" />
            <apex:actionFunction name="refresh" action="{!discardChanges}" onComplete="initSuperbox();waitOff();bindSelectiveDealsEvents();"/>
            <apex:actionFunction name="submitComment" action="{!setComment}" rerender="commentBox" oncomplete="initSuperbox();introAsTab();commentBoxShow();"/>
            
            <apex:actionFunction name="checkDeleteFinished" action="{!checkDeleteFinished}" rerender="delDealdiv,tableWrapper, errorMsg" onComplete="initSuperbox();checkStatus();genIds();bindSelectiveDealsEvents();loadBubbles();"/>  
            <apex:actionFunction name="deleteAllDeals" action="{!removeDealsCurrentView}" rerender="delDealdiv" onComplete="initSuperbox();checkDeleteFinished();bindSelectiveDealsEvents();"/> 
            <apex:actionFunction name="doSearch" action="{!doSearch}" rerender="tableWrapper, viewDrpdwn,contentButtons, newDealdiv, FixedCelsTableGrid" onComplete="initSuperbox();SearchComplete();genIds();bindSelectiveDealsEvents();loadBubbles();"/>                                           
            
            <apex:actionFunction name="goToPage" action="{!goToPage}"/>
            
            <apex:actionFunction name="closeComment" action="{!closeComment}"  rerender="commentBox" oncomplete="initSuperbox();fixCelsDimensions();introAsTab();waitOff();"/>
            <apex:actionFunction name="saveComment" action="{!saveComment}"  rerender="commentBox, tableContainer" oncomplete="initSuperbox();fixCelsDimensions();introAsTab();waitOff();bindSelectiveDealsEvents();"/>                                       

            <apex:actionfunction name="loadChatter" id="chatterLoader" action="{!loadChatter}" rerender="chatter" oncomplete="waitOff();initChatter();jQuery('.innerOcultar a').click();"/>
            <apex:actionFunction name="deleteSelectedDeals" rerender="tableWrapper, errorMsg, delButnWrapperDiv, info-success-div" action="{!removeSelectedDeals}" oncomplete="initSuperbox();waitOff();fixCelsDimensions();genIds();showRowCount();bindSelectiveDealsEvents();loadBubbles();">
                <apex:param name="indexString" value=""/>
            </apex:actionFunction>
        </apex:form>
    </div>      

    <c:XactlySMBFooterScript isChatterEnabled="{!isChatterEnabled}" loadPerformantJs="true" loadHeaderJs="true" />
    <apex:stylesheet value="{!URLFOR($Resource.XactlyExpress__XactlySMBResources ,'pages/css/XactlySMBCalculateStep3.css')}" />
    <script type="text/javascript" language="javascript" src="{!URLFOR($Resource.XactlySMBResources, 'pages/js/XactlySMBCalculateStep3.js')}"></script>
    <c:XactlySMBFeedbackTab />
    <c:XactlySMBComments publicCommentEnabled="true" privateCommentEnabled="true" readOnlyPublic="{!IF(isReadOnlyAdmin,true,false)}" readOnlyPrivate="{!IF(isReadOnlyAdmin,true,false)}" />
</apex:page>
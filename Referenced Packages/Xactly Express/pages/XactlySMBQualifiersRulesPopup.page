<apex:page id="qualifiersRulesPopup" controller="XactlyExpress.XactlySMBQualifiersRulesPopupCtl" sidebar="false" showHeader="false" standardStylesheets="true" action="{!redirectWhenAccessIsDenied}">
    <title></title>
    <style>
    body{
    background-color:transparent;
    background-image:none;
    min-width: 0;
	}
	   
	div.box .roundedBox2 {
	    background-color:#FFFFFF;
	    border-left:1px solid #BFBFBF;
	    border-right:1px solid #BFBFBF;
	}
	    
	div.box .roundedBox2 div.section {
	    padding:7px 15px 7px 40px;
	}
	    
	#titlewrapper input{
	    height:20px;
	}
	.PNovaBlackTitle1{
	    font-family: 'ProximaNovaLight' !important;
	    font-weight: normal !important; 
	    font-size: 30px;
	    color: #396f90;
	}
	   .superboxBody{
        max-height: 550px;
	    overflow-y: auto;
	    overflow-x: hidden;
	    width: 989px;
	    
        }
    input.advancedFormula{
        width:915px;
    }
    </style>
    <!-- Custom Cursor Loader -->
        <c:XactlySMBCursor />
    <!-- Custom Cursor Loader -->
    <apex:form id="theForm">
        <div class="superboxTop"></div>
        <div class="superboxBody">
	        <div style="padding: 15px;">
	            <apex:inputField value="{!dummyDeal.XactlyExpress__DealDate__c}" id="dummyElemennt" required="false" style="display:none;"/>
	                <apex:outputPanel id="errorMsg" layout="block">
	                    <c:XactlySMBErrorMsg error="{!errorMsg}"/>
	                    <input class="hidden" id="errorMsg" value="{!errorMsg}" />
	                </apex:outputPanel>
	                <div id="titlewrapper" style="padding-bottom:25px;">	                
		                <apex:outputpanel layout="block" styleClass="PNovaBlackTitle1" style="float:left">
			                <apex:outputtext value="{!$Label.xactlyexpress__qualifierRule}">
			                    <apex:param value="{!currentSettings.qualifierCap}"/>
			                </apex:outputtext>
		                </apex:outputpanel>
		                <apex:outputpanel layout="block" style="float:left;margin-left:10px;margin-top:5px;">
		                	<apex:inputField id="qualifName" value="{!currentQualifier.name}"/>
		                </apex:outputpanel>
	            		<div style="width:3px;height:23px;background-color:#ff0000;float:left;margin-top:5px;">&nbsp;</div>
		                <div style="clear:both;"></div>
		            </div>
		            
					<apex:outputPanel layout="block" styleClass="btn_close_lbox_wrapper" style="margin-top:-75px;">
	                    <apex:outputLink styleClass="a_btn_close_lbox" value="javascript:;" disabled="false" onclick="window.parent.jQuery.superbox.close();">
	                    	<apex:outputPanel layout="block" styleClass="btn_close_lbox">
	                    		&nbsp;
	                    	</apex:outputPanel>
	                    </apex:outputLink>
					</apex:outputPanel>		            
		            
	                <div class="box" style="width: 959px;">
	                    <div class="tFadeM">
	                        <div style="float: left;"><img class="img-tFadeL" src="{!URLFOR($Resource.XactlySMBResources ,'img/layout/tFadeL.png')}" /></div>
	                        <div style="float: right;"><img class="img-tFadeR" src="{!URLFOR($Resource.XactlySMBResources ,'img/layout/tFadeR.png')}" /></div>
	                        <div style="clear:both"></div>
	                    </div>
	                    <div class="roundedBox2">

                            <apex:outputPanel id="fieldSetContainer" layout="block">
                                
                               	<c:XactlySMBCriteriasComp id="critComp" isAdvancedFormula="{!currentQualifier.XactlyExpress__IsAdvancedFormula__c}" isQualifier="true" criterias="{!criterias}" qualifierTypes="{!qualifierTypes}"  periodOptions="{!PeriodOptions}" typeOptions="{!typeOptions}" creditList="{!creditList}" quotaList="{!quotaList}" creditListQuota="{!creditListQuota}" paymentList="{!paymentList}" criteriasInstance="{!criteriasInstance}" formulaOptions="{!formulaOptions}" systemFieldOptions="{!systemFieldOptions}" dataFieldOptions="{!criteriasInstance.numericDealPropertiesOptionsByColumnName}" />
                                <div style="height:150px">  
	                               	<div style="padding-left: 20px; height: 31px;background:url({!URLFOR($Resource.XactlySMBResources ,'img/layout/bottomBorder.png')}) repeat-x scroll 0 0 transparent;">
	                                   	
													<apex:outputPanel layout="block" styleClass="btn_silver_wrapper" style="margin:0px;" onmouseover="btnSilverOver(this);" onmouseout="btnSilverOut(this);" onclick="criteriasHandler.checkErrors('criteriaRow');">
	                    								<apex:outputPanel layout="inline" styleClass="btn_silver">
		                    								<apex:outputPanel layout="inline" styleClass="btn_silver_r">
	                    										<apex:outputText styleClass="a_btn_silver a_btn_silver_gray" value="{!$Label.xactlyexpress__AddField}" />
		                    								</apex:outputPanel>         									
	                    								</apex:outputPanel>
													</apex:outputPanel>
	                                   	
	                                   	
									</div>
									<div style="clear: both;"></div>
									<div>
										<apex:inputText id="deleteCriteriaKeyInput" value="{!criteriasInstance.deleteCriteriaKey}" style="display:none;" />
										<apex:inputText id="criteriaIndex" value="{!criteriasInstance.criteriaIndex}" style="display:none;" />
										<div id="isThereContainer" style="padding-left: 20px;padding-top:10px;">
										    {!$Label.IsThere}<apex:inputCheckbox value="{!currentQualifier.XactlyExpress__IsAdvancedFormula__c}" id="isAdvFormula" onclick="criteriasHandler.toggleAdvFormulas()" />
											<br />
											<apex:inputField id="advancedFormula" styleClass="advancedFormula {!IF(currentQualifier.XactlyExpress__IsAdvancedFormula__c == true,'displayed','hidden')}" value="{!currentQualifier.XactlyExpress__AdvancedFormula__c}" />  
										</div>	
									</div>
								</div> 
                            </apex:outputPanel>
					    </div>
							
							
							      
	                    <div class="img_repeat bm">
							<div class="img_no_repeat bl"></div>
							<div class="img_no_repeat br"></div>
						</div>
	                </div>
	            </div>
            </div>  
            
            
            
            <apex:outputpanel layout="block" id="superboxFooter" styleClass="superboxFooter">
                
                <div style="float: left; width: 28%; padding-top: 7px;margin-left:30px;">
                
													<apex:outputPanel layout="block" styleClass="btn_silver_wrapper" onmouseover="btnSilverOver(this);" onmouseout="btnSilverOut(this);" onclick="if(!checkErrorsSave('criteriaRow','saveAs')){return false;};">
	                    								<apex:outputPanel layout="inline" styleClass="btn_silver">
		                    								<apex:outputPanel layout="inline" styleClass="btn_silver_r">
	                    										<apex:outputText styleClass="a_btn_silver a_btn_silver_gray" value="{!$Label.xactlyexpress__SaveAs}" />
		                    								</apex:outputPanel>         									
	                    								</apex:outputPanel>
													</apex:outputPanel>
                

                </div>
                
                <div style="width: 33%; padding-top: 7px; float: left; text-align: center;">
                    <div class="btnAction">
                        <div style="display: inline-block;" class="btnAction">
                        
													<apex:outputPanel layout="block" styleClass="btn_silver_wrapper" onmouseover="btnSilverOver(this);" onmouseout="btnSilverOut(this);" onclick="if(!checkErrorsSave('criteriaRow')){return false;};">
	                    								<apex:outputPanel layout="inline" styleClass="btn_silver">
		                    								<apex:outputPanel layout="inline" styleClass="btn_silver_r">
	                    										<apex:outputText styleClass="a_btn_silver a_btn_silver_blue" value="{!$Label.xactlyexpress__saveClose}" />
		                    								</apex:outputPanel>         									
	                    								</apex:outputPanel>
													</apex:outputPanel>

													<apex:outputPanel layout="block" styleClass="btn_silver_wrapper" onmouseover="btnSilverOver(this);" onmouseout="btnSilverOut(this);" onclick="window.parent.jQuery.superbox.close();">
	                    								<apex:outputPanel layout="inline" styleClass="btn_silver">
		                    								<apex:outputPanel layout="inline" styleClass="btn_silver_r">
	                    										<apex:outputText styleClass="a_btn_silver a_btn_silver_gray" value="{!$Label.xactlyexpress__cancelClose}" />
		                    								</apex:outputPanel>         									
	                    								</apex:outputPanel>
													</apex:outputPanel>
                        
							
                        </div>
                    </div>
                </div>
                
				<div style="float: right; width: auto; margin-top: 7px;margin-right:30px;">
                	
													<apex:outputPanel layout="block" styleClass="btn_silver_wrapper" onmouseover="btnSilverOver(this);" onmouseout="btnSilverOut(this);" onclick="waitOn();removeQualifierRule();">
	                    								<apex:outputPanel layout="inline" styleClass="btn_silver">
		                    								<apex:outputPanel layout="inline" styleClass="btn_silver_r">
	                    										<apex:outputText styleClass="a_btn_silver a_btn_silver_gray" value="{!$Label.xactlyexpress__deleteRule}" />
		                    								</apex:outputPanel>         									
	                    								</apex:outputPanel>
													</apex:outputPanel>
                	
                </div>
                
                <div style="clear: both;"></div>  
            </apex:outputpanel>

            <apex:actionFunction name="dummy" action="{!addCriteria}" oncomplete="waitOff();criteriasHandler.setOperatorSelectValues('operatorCell');introAsTab();updateALLMonthOptValue();" rerender="fieldSetContainer"/>
            <apex:actionFunction name="addSubCriteria" action="{!addSubCriteria}" oncomplete="updateALLMonthOptValue();waitOff();criteriasHandler.setOperatorSelectValues('operatorCell');introAsTab();" rerender="fieldSetContainer"/>
            <apex:actionFunction name="deleteCriteriaAction" action="{!removeCriteria}" rerender="fieldSetContainer" oncomplete="criteriasHandler.updateAdvancedFormula();waitOff();criteriasHandler.setOperatorSelectValues('operatorCell');introAsTab();"/>
            <apex:actionFunction name="deleteSubCriteriaAction" action="{!removeSubCriteria}" rerender="fieldSetContainer" oncomplete="waitOff();criteriasHandler.setOperatorSelectValues('operatorCell');introAsTab();"/>
            <apex:actionFunction name="refreshCredits" action="{!dummy}" oncomplete="waitOff();" rerender="creditList,discardChanges,saveChanges"/>
            <apex:actionFunction name="saveQualifierAction" action="{!save}" rerender="errorMsg" oncomplete="waitOff();if(jQuery('input[id$=errorMsg]').val() != '')return false;window.parent.waitOn();window.parent.checkCalculation();window.parent.associateQualifier();window.parent.jQuery.superbox.close();"/>
            <apex:actionFunction name="saveAsQualifierAction" action="{!saveAs}" rerender="errorMsg" oncomplete="waitOff();if(jQuery('input[id$=errorMsg]').val() != '')return false;window.parent.waitOn();window.parent.refreshPaymentTable();window.parent.jQuery.superbox.close();" />
            <apex:actionFunction name="removeQualifierRule" action="{!removeQualifierRule}" rerender="errorMsg" oncomplete="waitOff();if(jQuery('input[id$=errorMsg]').val() != '')return false;window.parent.waitOn();window.parent.refreshPaymentTable();window.parent.jQuery.superbox.close();" />
            <!--  <apex:actionFunction name="dummy" action="{!addCriteria}" oncomplete="waitOff()">
                <apex:param name="firstParam" assignTo="{!state}" value="" />
            </apex:actionFunction>
            -->
        </apex:form>
        
        
        <input class="hidden" id="function_type_att" value="{!JSENCODE(FUNCTION_TYPE_ATTAINMENT)}" />
        <input class="hidden" id="function_type_credit" value="{!JSENCODE(FUNCTION_TYPE_CREDIT)}" />
        <input class="hidden" id="function_type_draw" value="{!JSENCODE(FUNCTION_TYPE_DRAW)}" />
        <input class="hidden" id="function_type_earning" value="{!JSENCODE(FUNCTION_TYPE_EARNING)}" />
        <input class="hidden" id="function_type_held" value="{!JSENCODE(FUNCTION_TYPE_HELD)}" />
        <input class="hidden" id="function_type_liability_amount" value="{!JSENCODE(FUNCTION_TYPE_LIABILITY_AMOUNT)}" />
        <input class="hidden" id="function_type_liability_balance" value="{!JSENCODE(FUNCTION_TYPE_LIABILITY_BALANCE)}" />
        <input class="hidden" id="function_type_payout" value="{!JSENCODE(FUNCTION_TYPE_PAYOUT)}" />
        <input class="hidden" id="function_type_release" value="{!JSENCODE(FUNCTION_TYPE_RELEASE)}" />
        <input class="hidden" id="nbrSeparator" value="{!HTMLENCODE(nbrSeparator)}" />
        <input class="hidden" id="nbrDecimal" value="{!HTMLENCODE(nbrDecimal)}" />
        <input class="hidden" id="session_id" value="{!$Api.Session_ID}" />
        <input class="hidden" id="namespace" value="{!JSENCODE(namespace)}" />
        <input class="hidden" id="user_id" value="{!$User.Id}" />
        
        <!-- criteriasHandler inputs -->
	    <input type="hidden" value="{!$Label.AdvFormulaMissingParenthesis}" id="labelsArr0"/>
	    <input type="hidden" value="{!$Label.advancedIsEmpty}" id="labelsArr1"/>
	    <input type="hidden" value="{!$Label.AdvanceFormulaCheckLogicalStatement}" id="labelsArr2"/>
	    <input type="hidden" value="{!$Label.AdvanceFormulaWrongChar}" id="labelsArr3"/>
	    <input type="hidden" value="{!$Label.WrongDateFormatJS}" id="labelsArr4"/>
	    <input type="hidden" value="{!$Label.errorsInCriteria}" id="labelsArr5"/>
	    <input type="hidden" value="{!$Label.deleteAFilterCriteria}" id="labelsArr6"/>
	    <input type="hidden" value="{!$Label.CriteriaNumberNotExists}" id="labelsArr7"/>
	    <input type="hidden" value="{!$Label.CriteriaNegativeNumbers}" id="labelsArr8"/>
	    <input type="hidden" value="{!$Label.incompleteAdvFmla}" id="labelsArr9"/>
	    <input type="hidden" value="{!$Label.invalidAdvFormula}" id="labelsArr10"/>
	    <input class="hidden" value="{!$Label.CriteriaNoLongerExist}" id="labelsArr11"/>
	    <input class="hidden" value="{!$Label.InvalidCharsOnAdvFormula}" id="labelsArr12"/>
    
        <input class="hidden" id="dealDateAttrId" value="{!criteriasInstance.dealDateAttrId}" />
        <input class="hidden" id="productAttrId" value="{!criteriasInstance.productAttrId}" />
        <input class="hidden" id="accountAttrId" value="{!criteriasInstance.accountAttrId}" />
        <input class="hidden" id="salespersonAttrId" value="{!criteriasInstance.salespersonAttrId}" />
        <input class="hidden" id="currencyAttrId" value="{!criteriasInstance.currencyAttrId}" />
        <input class="hidden" id="dateFirst" value="{!dateFirst}" />
        <input class="hidden" id="dateSeparator" value="{!dateSeparator}" />

        <!-- End of criteriasHandler inputs -->

        <div class="hidden">
            <input class="hidden" id="orgName" value="{!URLENCODE($Organization.Name)}" />
            <input class="hidden" id="orgId" value="{!URLENCODE($Organization.Id)}" />
            <input class="hidden" id="currentUserProfile" value="{!URLENCODE(currentUserProfile)}" />
            <input class="hidden" id="currentUserName" value="{!URLENCODE($User.FirstName + ' ' + $User.LastName)}" />
        </div>

        <apex:stylesheet value="{!URLFOR($Resource.XactlyExpress__XactlySMBResources ,'pages/css/XactlySMBQualifiersRulesPopup.css')}" />
 
        <c:XactlySMBFooterScript isChatterEnabled="{!isChatterEnabled}" loadPerformantJs="true" loadHeaderJs="false" />
        <apex:includeScript value="{!URLFOR($Resource.XactlyExpress__XactlySMBResources, 'js/criteriasHandler.js')}" />
    	
    	
    	
    	<script src="../../soap/ajax/21.0/connection.js" type="text/javascript"></script>
         
          <script type="text/javascript">
          	var attrTypes = new Array();
            <apex:repeat value="{!attributeTypes}" var="at">        
                attrTypes['{!JSENCODE(at.s)}'] = '{!JSENCODE(at.typ)}';        
            </apex:repeat>
         
         	jQuery(document).ready(function() {
         	    
         	    setTimeout("loadAnltc('XactlySMBQualifiersRulesPopup.php')", 1000);
	            criteriasHandler.init(
	            	jQuery('#dealDateAttrId').val(), 
	            	jQuery('#productAttrId').val(), 
	            	jQuery('#accountAttrId').val(), 
	            	jQuery('#salespersonAttrId').val(), 
	            	defaultCriteriasHandlerLabels(), 
	            	jQuery('#dateFirst').val(), 
	            	jQuery('#dateSeparator').val()
            	);
            
            	criteriasHandler.setCurrencyAttrId(jQuery('#currencyAttrId').val());
	            criteriasHandler.setAttainment(jQuery('#function_type_att').val());
	            criteriasHandler.setCredit(jQuery('#function_type_credit').val());
	            criteriasHandler.setPriorDraw(document.getElementById("function_type_draw").value);
                criteriasHandler.setPriorEarning(document.getElementById("function_type_earning").value);
                criteriasHandler.setPriorHeld(document.getElementById("function_type_held").value);
                criteriasHandler.setPriorLiabilityAmount(document.getElementById("function_type_liability_amount").value);
                criteriasHandler.setPriorLiabilityBalance(document.getElementById("function_type_liability_balance").value);
                criteriasHandler.setPriorPayout(document.getElementById("function_type_payout").value);
                criteriasHandler.setPriorRelease(document.getElementById("function_type_release").value);
                
                window.parent.waitOff();
                ///auto set, that the iframe that contains this page, have got the scrolling attribute = no
                window.parent.document.querySelector('div#superbox-innerbox > iframe').setAttribute('scrolling','no');
        	 });
            function defaultCriteriasHandlerLabels(){
                var labels=new Array();
                for(var i =0;i<=12;i++){
                    labels[i]=jQuery('#labelsArr'+i).val();
                }
                return labels;
            }
             var nbrSeparator = jQuery('#nbrSeparator').val();
             var nbrDecimal = jQuery('#nbrDecimal').val();
         
             function checkErrorsSave(rows,action){
                if(criteriasHandler.chkErrors(rows) && criteriasHandler.checkCriterias(jQuery('input[id$=advancedFormula]').attr('id'), true, rows) && criteriasHandler.checkSubCriterias() && criteriasHandler.isThereFormulaErrors() == false){
                   criteriasHandler.updateHiddenToSelectedValues();
                    criteriasHandler.overrideAdvancedFormula();
                    waitOn();
                    if(action == undefined) 
                    	saveQualifierAction();
                    else if(action == 'saveAs')
                    	saveAsQualifierAction();
                }else{ 
                    return false;
                }
            }
         
            /**
            ** Global Vars Definition
            */
            // Save Current Session ID
            var SESSION_ID = jQuery('#session_id').val();
            var NAMESPACE_PREFIX = jQuery('#namespace').val();
            var CURRENT_USER = jQuery('#user_id').val();
            
            // Call Constructor Methods
            window.onload = salesforceConstructor;
     
            /**
            ** Constructor Methods
            */
            function salesforceConstructor () {
                    // Login to the Application Org
                    var loginSuccess = salesforceLogin();
                    if (!loginSuccess) {
                        alert('Login Error!!');
                    }
            }
     
            /**
            ** Connect with the Salesforce API
            */
            function salesforceLogin () {
                var success = true;
                try{
                    sforce.connection.sessionId = SESSION_ID;
                    sforce.connection.defaultNamespace = NAMESPACE_PREFIX;
                }
                catch(error) {
                    success = false;
                }
                return success;
            }
                    
             
             
         </script>
         
</apex:page>